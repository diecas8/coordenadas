<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Coordenadas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f0f0f5;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            width: 350px;
        }

        #map {
            flex: 1;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        input, button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .history-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .card, #map {
                width: 100% !important;
            }
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <h1>üåç Convertidor de Coordenadas</h1>
    
    <div class="container">
        <div class="card">
            <button onclick="cambiarTema()">üåû/üåô Tema</button>
            
            <label>Latitud:</label>
            <input type="text" id="latitude" placeholder="Ej: 4.7110">
            
            <label>Longitud:</label>
            <input type="text" id="longitude" placeholder="Ej: -74.0721">
            
            <label>Notas:</label>
            <input type="text" id="notes" placeholder="Notas opcionales">
            
            <button onclick="convertCoordinates()">üß≠ Convertir</button>
            <button onclick="getCurrentLocation()">üìç Ubicaci√≥n Actual</button>
            
            <input type="file" id="geojson-file" accept=".geojson" 
                   style="margin-top: 15px;" onchange="handleGeoJSONUpload(event)">
        </div>
        
        <div id="map"></div>
    </div>

    <div class="history-container">
        <table id="historyTable">
            <thead>
                <tr>
                    <th>#</th><th>Lat</th><th>Lon</th><th>Lat (DMS)</th>
                    <th>Lon (DMS)</th><th>Sitio</th><th>Notas</th><th>üóëÔ∏è</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="exportToExcel()">üì§ Exportar Excel</button>
        <button onclick="clearHistory()">üßπ Limpiar Historial</button>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let map, marcadoresCluster;
        let markers = [];
        let savedHistory = JSON.parse(localStorage.getItem('history')) || [];
        
        // Inicializar mapa
        function initializeMap() {
            map = L.map('map').setView([4.7110, -74.0721], 5);
            
            // Capas base
            const capas = {
                "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }),
                "Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            };
            
            capas.OpenStreetMap.addTo(map);
            L.control.layers(capas).addTo(map);
            
            // Cluster de marcadores
            marcadoresCluster = L.markerClusterGroup();
            map.addLayer(marcadoresCluster);
            
            // Evento click en el mapa
            map.on('click', async e => {
                document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
                convertCoordinates();
            });
            
            restoreHistory();
        }

        // Restaurar historial
        function restoreHistory() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            savedHistory.forEach((entry, index) => {
                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${entry.lat.toFixed(6)}</td>
                    <td>${entry.lon.toFixed(6)}</td>
                    <td>${entry.dmsLat}</td>
                    <td>${entry.dmsLon}</td>
                    <td contenteditable>${entry.siteName}</td>
                    <td contenteditable>${entry.notes}</td>
                    <td><button onclick="deleteEntry(${index})">üóëÔ∏è</button></td>
                </tr>`;
                tbody.innerHTML += row;
                addMarker(entry.lat, entry.lon, entry.siteName);
            });
        }

        // Convertir coordenadas
        async function convertCoordinates() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const notes = document.getElementById('notes').value;
            
            if (isNaN(lat)) return alert('Latitud inv√°lida');
            if (isNaN(lon)) return alert('Longitud inv√°lida');
            
            try {
                const siteName = await getSiteName(lat, lon);
                const dmsLat = decimalToDMS(lat, 'lat');
                const dmsLon = decimalToDMS(lon, 'lon');
                
                addMarker(lat, lon, siteName);
                addToHistory(lat, lon, dmsLat, dmsLon, siteName, notes);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // A√±adir marcador
        function addMarker(lat, lon, siteName) {
            const marker = L.marker([lat, lon]).addTo(marcadoresCluster);
            marker.bindPopup(`<b>${siteName}</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}`);
            markers.push(marker);
        }

        // A√±adir al historial
        function addToHistory(lat, lon, dmsLat, dmsLon, siteName, notes) {
            const tbody = document.querySelector('#historyTable tbody');
            const row = `<tr>
                <td>${tbody.children.length + 1}</td>
                <td>${lat.toFixed(6)}</td>
                <td>${lon.toFixed(6)}</td>
                <td>${dmsLat}</td>
                <td>${dmsLon}</td>
                <td contenteditable>${siteName}</td>
                <td contenteditable>${notes}</td>
                <td><button onclick="deleteEntry(${markers.length - 1})">üóëÔ∏è</button></td>
            </tr>`;
            
            tbody.innerHTML += row;
            savedHistory.push({ lat, lon, dmsLat, dmsLon, siteName, notes });
            localStorage.setItem('history', JSON.stringify(savedHistory));
        }

        // Obtener nombre del lugar
        async function getSiteName(lat, lon) {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await response.json();
            return data.display_name || 'Ubicaci√≥n desconocida';
        }

        // Conversi√≥n a DMS
        function decimalToDMS(decimal, type) {
            const abs = Math.abs(decimal);
            const deg = Math.floor(abs);
            const min = Math.floor((abs - deg) * 60);
            const sec = ((abs - deg - min/60) * 3600).toFixed(2);
            const dir = type === 'lat' ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W');
            return `${deg}¬∞${min}'${sec}"${dir}`;
        }

        // Geolocalizaci√≥n
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalizaci√≥n");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('latitude').value = lat.toFixed(6);
                    document.getElementById('longitude').value = lon.toFixed(6);
                    convertCoordinates();
                },
                error => {
                    alert("Error: " + error.message);
                }
            );
        }

        // Funciones adicionales
        function deleteEntry(index) {
            if (!confirm('¬øEliminar esta entrada?')) return;
            markers[index].remove();
            markers.splice(index, 1);
            savedHistory.splice(index, 1);
            localStorage.setItem('history', JSON.stringify(savedHistory));
            location.reload();
        }

        function clearHistory() {
            if (!confirm('¬øBorrar todo el historial?')) return;
            localStorage.removeItem('history');
            location.reload();
        }

        function exportToExcel() {
            const wb = XLSX.utils.table_to_book(document.getElementById('historyTable'));
            XLSX.writeFile(wb, 'Historial_Coordenadas.xlsx');
        }

        function cambiarTema() {
            document.body.classList.toggle('tema-oscuro');
            document.querySelectorAll('.card, .history-container').forEach(el => {
                el.classList.toggle('tema-oscuro');
            });
        }

        // Iniciar
        initializeMap();
    </script>
</body>
</html>
