<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Coordenadas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f5;
            color: #333;
            transition: background 0.3s, color 0.3s;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin: 30px 0;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            width: 350px;
            transition: background 0.3s;
        }

        #map {
            flex: 1;
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        input, button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            transition: all 0.3s;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.9;
        }

        .history-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #666;
            font-size: 14px;
        }

        /* Tema oscuro */
        .tema-oscuro {
            background-color: #1a1a1a;
            color: #fff;
        }

        .tema-oscuro .card,
        .tema-oscuro .history-container {
            background: #2d2d2d;
            border-color: #444;
        }

        .tema-oscuro input,
        .tema-oscuro button {
            border-color: #555;
            background: #333;
            color: #fff;
        }

        .tema-oscuro .footer {
            color: #888;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .card, #map {
                width: 100% !important;
            }
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <h1>üìç Gestor de Coordenadas</h1>
    
    <div class="container">
        <div class="card">
            <button onclick="cambiarTema()">üåû/üåô Tema</button>
            
            <label>Latitud:</label>
            <input type="text" id="latitude" placeholder="Ej: 4.7110">
            
            <label>Longitud:</label>
            <input type="text" id="longitude" placeholder="Ej: -74.0721">
            
            <label>Notas:</label>
            <input type="text" id="notes" placeholder="Notas opcionales">
            
            <button onclick="getCurrentLocation()">üìç Ubicaci√≥n Actual</button>
            
            <input type="file" id="geojson-file" accept=".geojson" 
                   style="margin-top: 15px;" onchange="handleGeoJSONUpload(event)">
        </div>
        
        <div id="map"></div>
    </div>

    <div class="history-container">
        <table id="historyTable">
            <thead>
                <tr>
                    <th>#</th><th>Lat</th><th>Lon</th><th>Notas</th><th>üóëÔ∏è</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="exportToExcel()">üì§ Exportar Excel</button>
        <button onclick="clearHistory()">üßπ Limpiar</button>
    </div>

    <div class="footer">
        <p>Elaborado por Diego Casta√±o</p>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let map, marcadoresCluster;
        let markers = [];
        let savedHistory = JSON.parse(localStorage.getItem('history')) || [];
        
        // Inicializar mapa
        function initializeMap() {
            map = L.map('map').setView([4.7110, -74.0721], 5);
            
            // Capas base
            const capas = {
                "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }),
                "Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            };
            
            capas.OpenStreetMap.addTo(map);
            L.control.layers(capas).addTo(map);
            
            // Cluster de marcadores
            marcadoresCluster = L.markerClusterGroup();
            map.addLayer(marcadoresCluster);
            
            // Evento click en el mapa
            map.on('click', e => {
                document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
                agregarCoordenada();
            });
            
            restoreHistory();
        }

        // Restaurar historial
        function restoreHistory() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            savedHistory.forEach((entry, index) => {
                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${entry.lat}</td>
                    <td>${entry.lon}</td>
                    <td>${entry.notes}</td>
                    <td><button onclick="deleteEntry(${index})">üóëÔ∏è</button></td>
                </tr>`;
                tbody.innerHTML += row;
                addMarker(entry.lat, entry.lon);
            });
        }

        // Agregar coordenada
        function agregarCoordenada() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const notes = document.getElementById('notes').value;
            
            if(!lat || !lon) return;
            
            addMarker(lat, lon);
            addToHistory(lat, lon, notes);
        }

        // A√±adir marcador
        function addMarker(lat, lon) {
            const marker = L.marker([lat, lon]).addTo(marcadoresCluster);
            marker.bindPopup(`<b>Coordenada:</b><br>Lat: ${lat}<br>Lon: ${lon}`);
            markers.push(marker);
        }

        // A√±adir al historial
        function addToHistory(lat, lon, notes) {
            const tbody = document.querySelector('#historyTable tbody');
            const row = `<tr>
                <td>${tbody.children.length + 1}</td>
                <td>${lat}</td>
                <td>${lon}</td>
                <td>${notes}</td>
                <td><button onclick="deleteEntry(${markers.length - 1})">üóëÔ∏è</button></td>
            </tr>`;
            
            tbody.innerHTML += row;
            savedHistory.push({ lat, lon, notes });
            localStorage.setItem('history', JSON.stringify(savedHistory));
        }

        // Geolocalizaci√≥n
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalizaci√≥n");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(position => {
                document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                agregarCoordenada();
            }, error => {
                alert("Error: " + error.message);
            });
        }

        // Funciones adicionales
        function deleteEntry(index) {
            if (!confirm('¬øEliminar esta entrada?')) return;
            markers[index].remove();
            markers.splice(index, 1);
            savedHistory.splice(index, 1);
            localStorage.setItem('history', JSON.stringify(savedHistory));
            location.reload();
        }

        function clearHistory() {
            if (!confirm('¬øBorrar todo el historial?')) return;
            localStorage.removeItem('history');
            location.reload();
        }

        function exportToExcel() {
            const wb = XLSX.utils.table_to_book(document.getElementById('historyTable'));
            XLSX.writeFile(wb, 'Historial_Coordenadas.xlsx');
        }

        function cambiarTema() {
            document.body.classList.toggle('tema-oscuro');
            document.querySelectorAll('.card, .history-container').forEach(el => {
                el.classList.toggle('tema-oscuro');
            });
        }

        // Iniciar
        initializeMap();
    </script>
</body>
</html>
