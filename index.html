<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cartogr√°fico</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <style>
        /* Estilos existentes */
        body { font-family: Arial; margin: 20px; background: #f0f0f5; transition: 0.3s; }
        .container { display: flex; gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; width: 350px; }
        #map { flex: 1; height: 600px; border-radius: 10px; }
        /* Nuevos estilos */
        .leaflet-draw-toolbar a { background-image: url(https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/images/spritesheet.png); }
        #attributeForm { 
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .tema-oscuro #attributeForm { background: #333; color: white; }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Gestor Cartogr√°fico</h1>
    
    <div class="container">
        <div class="card">
            <button onclick="cambiarTema()">üåû/üåô Tema</button>
            <label>Latitud: <input type="text" id="latitude" placeholder="Ej: 4.7110"></label>
            <label>Longitud: <input type="text" id="longitude" placeholder="Ej: -74.0721"></label>
            <label>Notas: <input type="text" id="notes" placeholder="Notas opcionales"></label>
            <button onclick="getCurrentLocation()">üìç Ubicaci√≥n Actual</button>
            <input type="file" id="geojson-file" accept=".geojson" onchange="handleGeoJSONUpload(event)" style="margin-top:10px;">
        </div>
        <div id="map"></div>
    </div>

    <div class="history-container">
        <table id="historyTable"><!-- Contenido din√°mico --></table>
        <button onclick="exportToExcel()">üì§ Exportar Excel</button>
        <button onclick="clearHistory()">üßπ Limpiar</button>
    </div>

    <div id="attributeForm">
        <h3>Atributos de la Forma</h3>
        <label>Sitio: <input type="text" id="featureSite"></label><br>
        <label>Propietario: <input type="text" id="featureOwner"></label><br>
        <label>Observaciones: <textarea id="featureNotes"></textarea></label><br>
        <button onclick="saveFeatureAttributes()">üíæ Guardar</button>
    </div>

    <div class="footer">
        <button onclick="exportToGeoJSON()">üì§ Exportar GeoJSON</button>
        <p>Elaborado por Diego Casta√±o</p>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Variables globales
        let map, marcadoresCluster, drawnItems = new L.FeatureGroup();
        let markers = [], tempLayer = null;
        const savedHistory = JSON.parse(localStorage.getItem('history')) || [];
        const savedFeatures = JSON.parse(localStorage.getItem('geoFeatures')) || [];

        function initializeMap() {
            map = L.map('map').setView([4.7110, -74.0721], 5);
            
            // Capas base
            const capas = {
                "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            };
            capas.OpenStreetMap.addTo(map);
            L.control.layers(capas).addTo(map);

            // Control de dibujo
            const drawControl = new L.Control.Draw({
                draw: {
                    polygon: { shapeOptions: { color: '#3388ff' } },
                    polyline: { shapeOptions: { color: '#3388ff' } },
                    circle: false,
                    marker: false,
                    rectangle: false
                },
                edit: { featureGroup: drawnItems }
            });
            map.addControl(drawControl);

            // Eventos
            map.on(L.Draw.Event.CREATED, e => {
                tempLayer = e.layer;
                document.getElementById('attributeForm').style.display = 'block';
            });

            map.addLayer(drawnItems);
            loadSavedFeatures();
            restoreHistory();
        }

        function saveFeatureAttributes() {
            const feature = {
                type: 'Feature',
                geometry: tempLayer.toGeoJSON().geometry,
                properties: {
                    sitio: document.getElementById('featureSite').value,
                    propietario: document.getElementById('featureOwner').value,
                    observaciones: document.getElementById('featureNotes').value
                }
            };
            
            drawnItems.addLayer(tempLayer);
            savedFeatures.push(feature);
            localStorage.setItem('geoFeatures', JSON.stringify(savedFeatures));
            document.getElementById('attributeForm').style.display = 'none';
            tempLayer = null;
        }

        function loadSavedFeatures() {
            savedFeatures.forEach(feature => {
                const layer = L.geoJSON(feature, {
                    style: { color: '#3388ff' },
                    onEachFeature: (f, l) => l.bindPopup(`
                        <b>${f.properties.sitio}</b><br>
                        Propietario: ${f.properties.propietario}<br>
                        Observaciones: ${f.properties.observaciones}
                    `)
                });
                drawnItems.addLayer(layer);
            });
        }

        function exportToGeoJSON() {
            const geoJSONData = {
                type: 'FeatureCollection',
                features: [
                    ...savedFeatures,
                    ...savedHistory.map(entry => ({
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: [entry.lon, entry.lat] },
                        properties: { 
                            sitio: entry.siteName, 
                            notas: entry.notes 
                        }
                    }))
                ]
            };

            const dataStr = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(geoJSONData))}`;
            const link = document.createElement('a');
            link.href = dataStr;
            link.download = 'mapa.geojson';
            link.click();
        }

        // Funciones existentes (sin modificaciones)
        function restoreHistory() { /* ... */ }
        function addMarker(lat, lon) { /* ... */ }
        function addToHistory(lat, lon, notes) { /* ... */ }
        function getCurrentLocation() { /* ... */ }
        function deleteEntry(index) { /* ... */ }
        function clearHistory() { /* ... */ }
        function exportToExcel() { /* ... */ }
        function cambiarTema() { /* ... */ }

        window.onload = initializeMap;
    </script>
</body>
</html>
