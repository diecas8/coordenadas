<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cartogr√°fico Offline</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: #f0f0f5;
        }

        .container {
            display: flex;
            flex-grow: 1;
            gap: 20px;
            margin-top: 20px;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
            overflow-y: auto;
        }

        #map {
            flex-grow: 1;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .boton {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        #attributeForm {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .footer {
            text-align: center;
            padding: 15px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Mapa Offline con GPS</h1>
    
    <div class="container">
        <div class="control-panel">
            <button class="boton" onclick="iniciarRutaGPS()">üìç Iniciar Ruta GPS</button>
            <button class="boton" onclick="detenerRutaGPS()">‚èπÔ∏è Detener Ruta</button>
            <button class="boton" onclick="exportarDatos()">üì§ Exportar Datos</button>
            
            <h3 style="margin: 15px 0 10px;">Herramientas</h3>
            <button class="boton" onclick="activarDibujo('polygon')">üîµ Pol√≠gono</button>
            <button class="boton" onclick="activarDibujo('polyline')">üìè L√≠nea</button>
            <button class="boton" onclick="activarDibujo('marker')">üìç Punto</button>
            
            <div id="attributeForm">
                <h3>üìù Atributos</h3>
                <input type="text" id="nombre" placeholder="Nombre" required><br>
                <input type="text" id="tipo" placeholder="Tipo"><br>
                <textarea id="descripcion" placeholder="Descripci√≥n"></textarea><br>
                <button class="boton" onclick="guardarAtributos()">üíæ Guardar</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <div class="footer">
        <p>Desarrollado por Diego Casta√±o | Funciona offline</p>
    </div>

    <!-- Scripts principales -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Scripts para offline -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.offline/3.2.0/leaflet.offline.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

    <script>
        // Variables globales
        let map, drawnItems, currentLayer;
        let rutaGPS = null;
        let watchID = null;
        const capaBase = L.tileLayer.offline('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            subdomains: 'abc'
        });

        // Inicializaci√≥n del mapa
        function inicializarMapa() {
            map = L.map('map', {
                center: [4.7110, -74.0721],
                zoom: 13,
                layers: [capaBase]
            });

            // Capa para dibujar elementos
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Control de dibujo
            new L.Control.Draw({
                draw: {
                    polygon: true,
                    polyline: true,
                    circle: false,
                    marker: true,
                    rectangle: false
                },
                edit: {
                    featureGroup: drawnItems
                }
            }).addTo(map);

            // Eventos de dibujo
            map.on(L.Draw.Event.CREATED, function(e) {
                currentLayer = e.layer;
                document.getElementById('attributeForm').style.display = 'block';
                currentLayer.addTo(drawnItems);
            });

            // Cargar datos guardados
            cargarDatosGuardados();
        }

        // Funci√≥n para registrar ruta GPS
        function iniciarRutaGPS() {
            if (!navigator.geolocation) {
                alert("GPS no soportado en este navegador");
                return;
            }

            rutaGPS = L.polyline([], {color: 'red'}).addTo(map);
            
            watchID = navigator.geolocation.watchPosition(
                posicion => {
                    const latlng = [posicion.coords.latitude, posicion.coords.longitude];
                    
                    if(rutaGPS) {
                        rutaGPS.addLatLng(latlng);
                        map.panTo(latlng);
                    }
                },
                error => {
                    alert(`Error GPS: ${error.message}`);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                }
            );
        }

        function detenerRutaGPS() {
            if(watchID) navigator.geolocation.clearWatch(watchID);
            if(rutaGPS) {
                guardarElemento({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: rutaGPS.getLatLngs().map(ll => [ll.lng, ll.lat])
                    },
                    properties: {
                        nombre: 'Ruta GPS',
                        tipo: 'Ruta',
                        descripcion: 'Registro de ruta por GPS'
                    }
                });
                rutaGPS = null;
            }
        }

        // Gesti√≥n de atributos
        function guardarAtributos() {
            guardarElemento({
                type: 'Feature',
                geometry: currentLayer.toGeoJSON().geometry,
                properties: {
                    nombre: document.getElementById('nombre').value,
                    tipo: document.getElementById('tipo').value,
                    descripcion: document.getElementById('descripcion').value
                }
            });
            document.getElementById('attributeForm').style.display = 'none';
        }

        function guardarElemento(feature) {
            localStorage.setItem(`elemento_${Date.now()}`, JSON.stringify(feature));
            currentLayer.bindPopup(`<b>${feature.properties.nombre}</b><br>${feature.properties.descripcion}`);
        }

        function cargarDatosGuardados() {
            Object.keys(localStorage).forEach(key => {
                if(key.startsWith('elemento_')) {
                    const feature = JSON.parse(localStorage.getItem(key));
                    L.geoJSON(feature, {
                        pointToLayer: (geoJsonPoint, latlng) => L.marker(latlng),
                        style: {color: '#3498db'}
                    }).bindPopup(`<b>${feature.properties.nombre}</b><br>${feature.properties.descripcion}`)
                      .addTo(drawnItems);
                }
            });
        }

        // Exportaci√≥n de datos
        function exportarDatos() {
            const features = [];
            Object.keys(localStorage).forEach(key => {
                if(key.startsWith('elemento_')) {
                    features.push(JSON.parse(localStorage.getItem(key)));
                }
            });
            
            const geoJSON = {
                type: 'FeatureCollection',
                features: features
            };

            const blob = new Blob([JSON.stringify(geoJSON)], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'mapa-offline.geojson';
            link.click();
        }

        // Iniciar aplicaci√≥n
        window.onload = inicializarMapa;

        // Registrar Service Worker para offline
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(registration => console.log('ServiceWorker registrado'))
                .catch(error => console.log('Error ServiceWorker:', error));
        }
    </script>
</body>
</html>
