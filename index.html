<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cartogr√°fico con Google Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f5;
            color: #333;
            transition: 0.3s;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            width: 350px;
        }

        #map {
            flex: 1;
            height: 600px;
            border-radius: 10px;
        }

        #attributeForm {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .tema-oscuro #attributeForm { background: #333; color: white; }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Gestor Cartogr√°fico</h1>
    
    <div class="container">
        <div class="card">
            <button onclick="cambiarTema()">üåû/üåô Tema</button>
            <button onclick="exportToGeoJSON()">üì§ Exportar GeoJSON</button>
            <button onclick="document.getElementById('geojson-file').click()">üì• Importar GeoJSON</button>
            <input type="file" id="geojson-file" accept=".geojson" hidden onchange="handleGeoJSONUpload(event)">
        </div>
        <div id="map"></div>
    </div>

    <div id="attributeForm">
        <h3>Atributos</h3>
        <label>Sitio: <input type="text" id="featureSite"></label><br>
        <label>Propietario: <input type="text" id="featureOwner"></label><br>
        <label>Observaciones: <textarea id="featureNotes"></textarea></label><br>
        <button onclick="saveFeatureAttributes()">üíæ Guardar</button>
    </div>

    <div class="footer">
        <p>Elaborado por Diego Casta√±o</p>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-googlemutant/0.15.3/Leaflet.GoogleMutant.min.js"></script>

    <script>
        let map, drawnItems = new L.FeatureGroup();
        let tempLayer = null;
        const savedFeatures = JSON.parse(localStorage.getItem('geoFeatures')) || [];

        function initializeMap() {
            // Configurar Google Maps como base
            map = L.map('map').setView([4.7110, -74.0721], 5);
            
            // Capa de Google Maps
            const googleLayer = L.gridLayer.googleMutant({
                type: 'roadmap',
                maxZoom: 20
            }).addTo(map);

            // Control de dibujo
            const drawControl = new L.Control.Draw({
                draw: {
                    polygon: { shapeOptions: { color: '#3388ff' } },
                    polyline: { shapeOptions: { color: '#3388ff' } },
                    circle: false,
                    marker: false,
                    rectangle: false
                },
                edit: { featureGroup: drawnItems }
            });
            map.addControl(drawControl);

            // Eventos
            map.on(L.Draw.Event.CREATED, e => {
                tempLayer = e.layer;
                document.getElementById('attributeForm').style.display = 'block';
            });

            map.addLayer(drawnItems);
            loadSavedFeatures();
        }

        function handleGeoJSONUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = e => {
                const geoJSON = JSON.parse(e.target.result);
                geoJSON.features.forEach(feature => {
                    const layer = L.geoJSON(feature, {
                        style: { color: '#3388ff' },
                        onEachFeature: (f, l) => {
                            l.bindPopup(`
                                <b>${f.properties.sitio}</b><br>
                                Propietario: ${f.properties.propietario}<br>
                                Observaciones: ${f.properties.observaciones}
                            `);
                            drawnItems.addLayer(l);
                        }
                    });
                });
                map.fitBounds(drawnItems.getBounds());
            };
            reader.readAsText(file);
        }

        function saveFeatureAttributes() {
            const feature = {
                type: 'Feature',
                geometry: tempLayer.toGeoJSON().geometry,
                properties: {
                    sitio: document.getElementById('featureSite').value,
                    propietario: document.getElementById('featureOwner').value,
                    observaciones: document.getElementById('featureNotes').value
                }
            };
            
            drawnItems.addLayer(tempLayer);
            savedFeatures.push(feature);
            localStorage.setItem('geoFeatures', JSON.stringify(savedFeatures));
            document.getElementById('attributeForm').style.display = 'none';
            tempLayer.bindPopup(`
                <b>${feature.properties.sitio}</b><br>
                ${feature.properties.observaciones}
            `);
            tempLayer = null;
        }

        function loadSavedFeatures() {
            savedFeatures.forEach(feature => {
                const layer = L.geoJSON(feature, {
                    style: { color: '#3388ff' },
                    onEachFeature: (f, l) => l.bindPopup(`
                        <b>${f.properties.sitio}</b><br>
                        Propietario: ${f.properties.propietario}<br>
                        Observaciones: ${f.properties.observaciones}
                    `)
                });
                drawnItems.addLayer(layer);
            });
        }

        function exportToGeoJSON() {
            const geoJSONData = {
                type: 'FeatureCollection',
                features: savedFeatures
            };

            const dataStr = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(geoJSONData))}`;
            const link = document.createElement('a');
            link.href = dataStr;
            link.download = 'mapa-exportado.geojson';
            link.click();
        }

        function cambiarTema() {
            document.body.classList.toggle('tema-oscuro');
        }

        // Inicializar mapa
        initializeMap();
    </script>
</body>
</html>
