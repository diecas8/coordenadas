<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal de Verificación - Diagnóstico CVC 2025</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
        }
        
        header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3c72 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .credits {
            font-size: 0.9rem;
            font-style: italic;
        }
        
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background-color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 900;
        }
        
        .instructions {
            background-color: #e9f7fe;
            border-left: 4px solid #2c5aa0;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .instructions h2 {
            color: #2c5aa0;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .file-upload {
            margin-bottom: 20px;
        }
        
        .file-upload-label {
            display: block;
            background-color: #2c5aa0;
            color: white;
            padding: 12px 15px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }
        
        .file-upload-label:hover {
            background-color: #1e3c72;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .filters {
            margin-top: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .legend {
            margin-top: 30px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .legend h3 {
            margin-bottom: 10px;
            color: #2c5aa0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
            border: 1px solid #999;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4);
            z-index: 800;
        }
        
        footer {
            text-align: center;
            padding: 10px;
            background-color: #2c5aa0;
            color: white;
            font-size: 0.9rem;
        }
        
        .popup-content {
            min-width: 200px;
        }
        
        .popup-content h4 {
            margin-bottom: 8px;
            color: #2c5aa0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .popup-content p {
            margin: 5px 0;
        }
        
        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Geoportal de Verificación - Diagnóstico CVC 2025</h1>
            <div class="credits">Elaborado por Diego Castaño, Esp SIG. 2025</div>
        </div>
    </header>
    
    <main>
        <aside class="sidebar">
            <div class="instructions">
                <h2>Instrucciones de uso</h2>
                <ol>
                    <li>Cargue el archivo CSV con los datos de la encuesta</li>
                    <li>Seleccione las columnas que contienen latitud y longitud</li>
                    <li>Seleccione la columna que contiene el nombre del municipio</li>
                    <li>Los puntos se mostrarán en el mapa con colores diferentes por municipio</li>
                    <li>Haga clic en cualquier punto para ver sus atributos</li>
                    <li>Use los filtros para mostrar u ocultar municipios específicos</li>
                </ol>
            </div>
            
            <div class="file-upload">
                <label for="csv-file" class="file-upload-label">Seleccionar archivo CSV</label>
                <input type="file" id="csv-file" accept=".csv">
                <div id="file-name"></div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="lat-select">Columna de Latitud:</label>
                    <select id="lat-select"></select>
                </div>
                
                <div class="filter-group">
                    <label for="lng-select">Columna de Longitud:</label>
                    <select id="lng-select"></select>
                </div>
                
                <div class="filter-group">
                    <label for="municipio-select">Columna de Municipio:</label>
                    <select id="municipio-select"></select>
                </div>
                
                <div class="filter-group">
                    <label for="municipio-filter">Filtrar por Municipio:</label>
                    <select id="municipio-filter" multiple>
                        <option value="all" selected>Todos los municipios</option>
                    </select>
                </div>
            </div>
            
            <div class="legend">
                <h3>Leyenda</h3>
                <div id="legend-content">
                    <p>Los puntos se colorearán automáticamente según el municipio después de cargar los datos.</p>
                </div>
            </div>
        </aside>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="map-overlay">
                <div id="map-info">Cargue un archivo CSV para visualizar los datos</div>
            </div>
        </div>
    </main>
    
    <footer>
        Geoportal de Verificación - Diagnóstico CVC 2025 - Elaborado por Diego Castaño, Esp SIG. 2025
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PapaParse para leer CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        // Variables globales
        let map;
        let dataLayer;
        let allData = [];
        let municipioColors = {};
        
        // Inicializar el mapa
        function initMap() {
            // Centrar el mapa en Colombia (aproximadamente)
            map = L.map('map').setView([4.5709, -74.2973], 8);
            
            // Capa base de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Capa con más detalle (USGS)
            L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 20,
                attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>'
            }).addTo(map);
            
            // Inicializar la capa para los datos
            dataLayer = L.layerGroup().addTo(map);
            
            // Actualizar información del mapa
            updateMapInfo('Cargue un archivo CSV para visualizar los datos');
        }
        
        // Actualizar la información del mapa en el overlay
        function updateMapInfo(text) {
            document.getElementById('map-info').textContent = text;
        }
        
        // Leer el archivo CSV
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('file-name').textContent = `Archivo seleccionado: ${file.name}`;
            updateMapInfo('Procesando archivo CSV...');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        updateMapInfo('El archivo CSV no contiene datos válidos');
                        return;
                    }
                    
                    allData = results.data;
                    const headers = results.meta.fields;
                    
                    // Llenar los selectores de columnas
                    const latSelect = document.getElementById('lat-select');
                    const lngSelect = document.getElementById('lng-select');
                    const municipioSelect = document.getElementById('municipio-select');
                    
                    latSelect.innerHTML = '';
                    lngSelect.innerHTML = '';
                    municipioSelect.innerHTML = '';
                    
                    headers.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        
                        latSelect.appendChild(option.cloneNode(true));
                        lngSelect.appendChild(option.cloneNode(true));
                        municipioSelect.appendChild(option.cloneNode(true));
                        
                        // Intentar detectar automáticamente las columnas de coordenadas
                        if (header.toLowerCase().includes('lat')) {
                            latSelect.value = header;
                        }
                        if (header.toLowerCase().includes('lon') || header.toLowerCase().includes('lng')) {
                            lngSelect.value = header;
                        }
                        if (header.toLowerCase().includes('municipio') || header.toLowerCase().includes('municipality')) {
                            municipioSelect.value = header;
                        }
                    });
                    
                    // Actualizar los datos cuando se seleccionen las columnas
                    latSelect.addEventListener('change', processData);
                    lngSelect.addEventListener('change', processData);
                    municipioSelect.addEventListener('change', processData);
                    
                    // Procesar datos con las columnas seleccionadas
                    processData();
                },
                error: function(error) {
                    console.error('Error al leer el CSV:', error);
                    updateMapInfo('Error al procesar el archivo CSV');
                }
            });
        });
        
        // Procesar los datos y mostrarlos en el mapa
        function processData() {
            const latField = document.getElementById('lat-select').value;
            const lngField = document.getElementById('lng-select').value;
            const municipioField = document.getElementById('municipio-select').value;
            
            if (!latField || !lngField || !municipioField) {
                updateMapInfo('Seleccione las columnas de latitud, longitud y municipio');
                return;
            }
            
            // Limpiar capa anterior
            dataLayer.clearLayers();
            
            // Obtener lista de municipios únicos
            const municipios = [...new Set(allData.map(item => item[municipioField]))].filter(Boolean);
            
            // Actualizar filtro de municipios
            const municipioFilter = document.getElementById('municipio-filter');
            municipioFilter.innerHTML = '<option value="all" selected>Todos los municipios</option>';
            
            municipios.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                municipioFilter.appendChild(option);
            });
            
            // Generar colores para cada municipio
            municipioColors = {};
            municipios.forEach((municipio, index) => {
                const hue = (index * 137.5) % 360; // Distribución áurea de colores
                municipioColors[municipio] = `hsl(${hue}, 70%, 50%)`;
            });
            
            // Actualizar leyenda
            const legendContent = document.getElementById('legend-content');
            legendContent.innerHTML = '';
            
            Object.entries(municipioColors).forEach(([municipio, color]) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = color;
                
                const label = document.createElement('span');
                label.textContent = municipio;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legendContent.appendChild(legendItem);
            });
            
            // Añadir puntos al mapa
            let bounds = [];
            
            allData.forEach(item => {
                const lat = parseFloat(item[latField]);
                const lng = parseFloat(item[lngField]);
                const municipio = item[municipioField];
                
                if (isNaN(lat) || isNaN(lng) || !municipio) {
                    return; // Saltar datos inválidos
                }
                
                const color = municipioColors[municipio] || '#3388ff';
                
                // Crear marcador
                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Crear contenido del popup
                let popupContent = `<div class="popup-content"><h4>${municipio}</h4>`;
                
                Object.entries(item).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) {
                        popupContent += `<p><strong>${key}:</strong> ${value}</p>`;
                    }
                });
                
                popupContent += '</div>';
                
                marker.bindPopup(popupContent, { maxWidth: 300 });
                marker.addTo(dataLayer);
                
                bounds.push([lat, lng]);
            });
            
            // Ajustar el zoom para mostrar todos los puntos
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            updateMapInfo(`Datos cargados: ${allData.length} puntos de ${municipios.length} municipios`);
            
            // Configurar el evento de filtrado
            document.getElementById('municipio-filter').addEventListener('change', filterData);
        }
        
        // Filtrar datos por municipio
        function filterData() {
            const municipioField = document.getElementById('municipio-select').value;
            const selectedOptions = Array.from(document.getElementById('municipio-filter').selectedOptions);
            const selectedValues = selectedOptions.map(option => option.value);
            
            dataLayer.clearLayers();
            
            let bounds = [];
            let visibleCount = 0;
            
            allData.forEach(item => {
                const lat = parseFloat(item[document.getElementById('lat-select').value]);
                const lng = parseFloat(item[document.getElementById('lng-select').value]);
                const municipio = item[municipioField];
                
                if (isNaN(lat) || isNaN(lng) || !municipio) {
                    return;
                }
                
                // Verificar si el municipio está seleccionado o si se seleccionó "todos"
                if (selectedValues.includes('all') || selectedValues.includes(municipio)) {
                    const color = municipioColors[municipio] || '#3388ff';
                    
                    const marker = L.circleMarker([lat, lng], {
                        radius: 8,
                        fillColor: color,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    let popupContent = `<div class="popup-content"><h4>${municipio}</h4>`;
                    
                    Object.entries(item).forEach(([key, value]) => {
                        if (value !== null && value !== undefined) {
                            popupContent += `<p><strong>${key}:</strong> ${value}</p>`;
                        }
                    });
                    
                    popupContent += '</div>';
                    
                    marker.bindPopup(popupContent, { maxWidth: 300 });
                    marker.addTo(dataLayer);
                    
                    bounds.push([lat, lng]);
                    visibleCount++;
                }
            });
            
            // Ajustar el zoom para mostrar los puntos visibles
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            updateMapInfo(`Mostrando ${visibleCount} de ${allData.length} puntos`);
        }
        
        // Inicializar el mapa cuando se carga la página
        window.onload = initMap;
    </script>
</body>
</html>
