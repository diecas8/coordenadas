<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal de Verificación - Diagnóstico CVC 2025</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
        }
        
        header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3c72 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .credits {
            font-size: 0.9rem;
            font-style: italic;
        }
        
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background-color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 900;
        }
        
        .instructions {
            background-color: #e9f7fe;
            border-left: 4px solid #2c5aa0;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .instructions h2 {
            color: #2c5aa0;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .file-upload {
            margin-bottom: 20px;
        }
        
        .file-upload-label {
            display: block;
            background-color: #2c5aa0;
            color: white;
            padding: 12px 15px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }
        
        .file-upload-label:hover {
            background-color: #1e3c72;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 4px;
            border: 1px dashed #2c5aa0;
        }
        
        .filters {
            margin-top: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .stats {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .stats h3 {
            margin-bottom: 10px;
            color: #2c5aa0;
        }
        
        .stats p {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .stats span {
            font-weight: 600;
        }
        
        .legend {
            margin-top: 20px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .legend h3 {
            margin-bottom: 10px;
            color: #2c5aa0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
            border: 1px solid #999;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.4);
            z-index: 800;
            font-size: 0.9rem;
            max-width: 300px;
        }
        
        footer {
            text-align: center;
            padding: 10px;
            background-color: #2c5aa0;
            color: white;
            font-size: 0.9rem;
        }
        
        .popup-content {
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .popup-content h4 {
            margin-bottom: 8px;
            color: #2c5aa0;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .popup-content p {
            margin: 5px 0;
            font-size: 0.9rem;
        }
        
        .debug-info {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #ff4d4d;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: none;
        }
        
        .debug-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff4f4;
            border-radius: 4px;
            border: 1px solid #ffcccc;
            display: none;
        }
        
        .debug-panel h3 {
            color: #d9534f;
            margin-bottom: 10px;
        }
        
        .debug-toggle {
            color: #2c5aa0;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            display: inline-block;
        }
        
        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Geoportal de Verificación - Diagnóstico CVC 2025</h1>
            <div class="credits">Elaborado por Diego Castaño, Esp SIG. 2025</div>
        </div>
    </header>
    
    <main>
        <aside class="sidebar">
            <div class="instructions">
                <h2>Instrucciones de uso</h2>
                <ol>
                    <li>Cargue el archivo CSV con los datos de la encuesta</li>
                    <li>Seleccione las columnas que contienen latitud y longitud</li>
                    <li>Seleccione la columna que contiene el nombre del municipio</li>
                    <li>Los puntos se mostrarán en el mapa con colores diferentes por municipio</li>
                    <li>Haga clic en cualquier punto para ver sus atributos</li>
                    <li>Use los filtros para mostrar u ocultar municipios específicos</li>
                </ol>
            </div>
            
            <div class="file-upload">
                <label for="csv-file" class="file-upload-label">Seleccionar archivo CSV</label>
                <input type="file" id="csv-file" accept=".csv">
                <div id="file-info" class="file-info">Esperando archivo...</div>
            </div>
            
            <div class="stats">
                <h3>Estadísticas</h3>
                <p>Total de registros: <span id="total-records">0</span></p>
                <p>Registros mostrados: <span id="shown-records">0</span></p>
                <p>Registros con error: <span id="error-records">0</span></p>
                <p>Municipios detectados: <span id="municipios-count">0</span></p>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="lat-select">Columna de Latitud:</label>
                    <select id="lat-select"></select>
                </div>
                
                <div class="filter-group">
                    <label for="lng-select">Columna de Longitud:</label>
                    <select id="lng-select"></select>
                </div>
                
                <div class="filter-group">
                    <label for="municipio-select">Columna de Municipio:</label>
                    <select id="municipio-select"></select>
                </div>
                
                <div class="filter-group">
                    <label for="municipio-filter">Filtrar por Municipio:</label>
                    <select id="municipio-filter" multiple>
                        <option value="all" selected>Todos los municipios</option>
                    </select>
                    <div class="debug-info">Mantén Ctrl para seleccionar múltiples</div>
                </div>
            </div>
            
            <div class="legend">
                <h3>Leyenda</h3>
                <div id="legend-content">
                    <p>Los puntos se colorearán automáticamente según el municipio después de cargar los datos.</p>
                </div>
            </div>
            
            <div class="debug-toggle" id="debug-toggle">Mostrar información de depuración</div>
            
            <div class="debug-panel" id="debug-panel">
                <h3>Información de Depuración</h3>
                <div id="debug-content"></div>
            </div>
        </aside>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="map-overlay">
                <div id="map-info">Cargue un archivo CSV para visualizar los datos</div>
                <div id="zoom-info" class="debug-info">Nivel de zoom: <span id="zoom-level">8</span></div>
            </div>
        </div>
    </main>
    
    <div class="notification" id="notification"></div>
    
    <footer>
        Geoportal de Verificación - Diagnóstico CVC 2025 - Elaborado por Diego Castaño, Esp SIG. 2025
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PapaParse para leer CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <script>
        // Variables globales
        let map;
        let dataLayer;
        let allData = [];
        let municipioColors = {};
        let errorRecords = 0;
        let debugData = [];
        
        // Inicializar el mapa
        function initMap() {
            // Centrar el mapa en Colombia (aproximadamente)
            map = L.map('map').setView([4.5709, -74.2973], 8);
            
            // Capa base de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Capa con más detalle (ESRI World Imagery)
            const esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            });
            
            // Capa de límites administrativos
            const boundaryLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                opacity: 0.7
            });
            
            // Añadir control de capas
            const baseMaps = {
                "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "Imágenes Satélite": esriLayer
            };
            
            const overlayMaps = {
                "Límites": boundaryLayer
            };
            
            L.control.layers(baseMaps, overlayMaps).addTo(map);
            
            // Inicializar la capa para los datos
            dataLayer = L.layerGroup().addTo(map);
            
            // Actualizar información del mapa
            updateMapInfo('Cargue un archivo CSV para visualizar los datos');
            
            // Actualizar nivel de zoom
            map.on('zoomend', function() {
                document.getElementById('zoom-level').textContent = map.getZoom();
            });
            
            // Configurar panel de depuración
            document.getElementById('debug-toggle').addEventListener('click', function() {
                const panel = document.getElementById('debug-panel');
                if (panel.style.display === 'block') {
                    panel.style.display = 'none';
                    this.textContent = 'Mostrar información de depuración';
                } else {
                    panel.style.display = 'block';
                    this.textContent = 'Ocultar información de depuración';
                    updateDebugInfo();
                }
            });
        }
        
        // Mostrar notificación
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }
        
        // Actualizar la información del mapa en el overlay
        function updateMapInfo(text) {
            document.getElementById('map-info').textContent = text;
        }
        
        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('total-records').textContent = allData.length;
            document.getElementById('error-records').textContent = errorRecords;
            document.getElementById('municipios-count').textContent = Object.keys(municipioColors).length;
        }
        
        // Actualizar información de depuración
        function updateDebugInfo() {
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML = '';
            
            if (debugData.length > 0) {
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.marginTop = '10px';
                
                // Encabezados de tabla
                let headerRow = document.createElement('tr');
                ['Registro', 'Problema', 'Valores'].forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    th.style.border = '1px solid #ccc';
                    th.style.padding = '5px';
                    th.style.textAlign = 'left';
                    th.style.backgroundColor = '#f0f0f0';
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                
                // Datos de depuración
                debugData.forEach(debug => {
                    const row = document.createElement('tr');
                    
                    const indexCell = document.createElement('td');
                    indexCell.textContent = debug.index;
                    indexCell.style.border = '1px solid #ccc';
                    indexCell.style.padding = '5px';
                    
                    const problemCell = document.createElement('td');
                    problemCell.textContent = debug.problem;
                    problemCell.style.border = '1px solid #ccc';
                    problemCell.style.padding = '5px';
                    
                    const valuesCell = document.createElement('td');
                    valuesCell.textContent = debug.values;
                    valuesCell.style.border = '1px solid #ccc';
                    valuesCell.style.padding = '5px';
                    valuesCell.style.fontFamily = 'monospace';
                    valuesCell.style.fontSize = '0.8rem';
                    
                    row.appendChild(indexCell);
                    row.appendChild(problemCell);
                    row.appendChild(valuesCell);
                    table.appendChild(row);
                });
                
                debugContent.appendChild(table);
            } else {
                debugContent.innerHTML = '<p>No se detectaron problemas con los datos.</p>';
            }
        }
        
        // Leer el archivo CSV
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('file-info').textContent = `Archivo: ${file.name} (${(file.size/1024).toFixed(2)} KB)`;
            updateMapInfo('Procesando archivo CSV...');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        updateMapInfo('El archivo CSV no contiene datos válidos');
                        showNotification('El archivo CSV no contiene datos válidos', 5000);
                        return;
                    }
                    
                    allData = results.data;
                    errorRecords = 0;
                    debugData = [];
                    const headers = results.meta.fields;
                    
                    // Llenar los selectores de columnas
                    const latSelect = document.getElementById('lat-select');
                    const lngSelect = document.getElementById('lng-select');
                    const municipioSelect = document.getElementById('municipio-select');
                    
                    latSelect.innerHTML = '';
                    lngSelect.innerHTML = '';
                    municipioSelect.innerHTML = '';
                    
                    headers.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        
                        latSelect.appendChild(option.cloneNode(true));
                        lngSelect.appendChild(option.cloneNode(true));
                        municipioSelect.appendChild(option.cloneNode(true));
                        
                        // Intentar detectar automáticamente las columnas de coordenadas
                        if (header.toLowerCase().includes('lat')) {
                            latSelect.value = header;
                        }
                        if (header.toLowerCase().includes('lon') || header.toLowerCase().includes('lng')) {
                            lngSelect.value = header;
                        }
                        if (header.toLowerCase().includes('municipio') || header.toLowerCase().includes('municipality') || 
                            header.toLowerCase().includes('ciudad') || header.toLowerCase().includes('city')) {
                            municipioSelect.value = header;
                        }
                    });
                    
                    // Actualizar los datos cuando se seleccionen las columnas
                    latSelect.addEventListener('change', processData);
                    lngSelect.addEventListener('change', processData);
                    municipioSelect.addEventListener('change', processData);
                    
                    // Procesar datos con las columnas seleccionadas
                    processData();
                    
                    showNotification(`Datos cargados: ${allData.length} registros`, 3000);
                },
                error: function(error) {
                    console.error('Error al leer el CSV:', error);
                    updateMapInfo('Error al procesar el archivo CSV');
                    showNotification('Error al procesar el archivo CSV: ' + error.message, 5000);
                }
            });
        });
        
        // Procesar los datos y mostrarlos en el mapa
        function processData() {
            const latField = document.getElementById('lat-select').value;
            const lngField = document.getElementById('lng-select').value;
            const municipioField = document.getElementById('municipio-select').value;
            
            if (!latField || !lngField || !municipioField) {
                updateMapInfo('Seleccione las columnas de latitud, longitud y municipio');
                return;
            }
            
            // Limpiar capa anterior
            dataLayer.clearLayers();
            errorRecords = 0;
            debugData = [];
            
            // Obtener lista de municipios únicos
            const municipios = [...new Set(allData
                .map(item => item[municipioField])
                .filter(municipio => municipio !== undefined && municipio !== null && municipio !== '')
            )];
            
            // Actualizar filtro de municipios
            const municipioFilter = document.getElementById('municipio-filter');
            municipioFilter.innerHTML = '<option value="all" selected>Todos los municipios</option>';
            
            municipios.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                municipioFilter.appendChild(option);
            });
            
            // Generar colores para cada municipio
            municipioColors = {};
            municipios.forEach((municipio, index) => {
                const hue = (index * 137.5) % 360; // Distribución áurea de colores
                municipioColors[municipio] = `hsl(${hue}, 70%, 50%)`;
            });
            
            // Actualizar leyenda
            const legendContent = document.getElementById('legend-content');
            legendContent.innerHTML = '';
            
            Object.entries(municipioColors).forEach(([municipio, color]) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = color;
                
                const label = document.createElement('span');
                label.textContent = municipio;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                legendContent.appendChild(legendItem);
            });
            
            // Añadir puntos al mapa
            let bounds = [];
            let validRecords = 0;
            
            allData.forEach((item, index) => {
                let lat = item[latField];
                let lng = item[lngField];
                const municipio = item[municipioField];
                
                // Verificar y limpiar coordenadas
                if (typeof lat === 'string') {
                    lat = lat.replace(',', '.').trim();
                }
                if (typeof lng === 'string') {
                    lng = lng.replace(',', '.').trim();
                }
                
                lat = parseFloat(lat);
                lng = parseFloat(lng);
                
                if (isNaN(lat) || isNaN(lng)) {
                    errorRecords++;
                    debugData.push({
                        index: index + 2, // +2 porque la primera fila es el encabezado y index empieza en 0
                        problem: 'Coordenadas inválidas',
                        values: `Lat: ${item[latField]}, Lng: ${item[lngField]}`
                    });
                    return; // Saltar datos inválidos
                }
                
                if (!municipio) {
                    errorRecords++;
                    debugData.push({
                        index: index + 2,
                        problem: 'Municipio no definido',
                        values: `Municipio: ${item[municipioField]}`
                    });
                    return;
                }
                
                // Verificar si las coordenadas están dentro de un rango razonable para Colombia
                if (lat < -4.0 || lat > 13.0 || lng < -82.0 || lng > -66.0) {
                    errorRecords++;
                    debugData.push({
                        index: index + 2,
                        problem: 'Coordenadas fuera de Colombia',
                        values: `Lat: ${lat}, Lng: ${lng}`
                    });
                    return;
                }
                
                const color = municipioColors[municipio] || '#3388ff';
                
                // Crear marcador
                const marker = L.circleMarker([lat, lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Crear contenido del popup
                let popupContent = `<div class="popup-content"><h4>${municipio}</h4>`;
                
                Object.entries(item).forEach(([key, value]) => {
                    if (value !== null && value !== undefined && value !== '') {
                        popupContent += `<p><strong>${key}:</strong> ${value}</p>`;
                    }
                });
                
                popupContent += '</div>';
                
                marker.bindPopup(popupContent, { maxWidth: 300 });
                marker.addTo(dataLayer);
                
                bounds.push([lat, lng]);
                validRecords++;
            });
            
            // Ajustar el zoom para mostrar todos los puntos
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Actualizar estadísticas
            document.getElementById('shown-records').textContent = validRecords;
            updateStats();
            
            updateMapInfo(`${validRecords} puntos de ${municipios.length} municipios`);
            
            if (errorRecords > 0) {
                showNotification(`Se omitieron ${errorRecords} registros con datos incompletos o inválidos`, 5000);
            }
            
            // Actualizar información de depuración si el panel está visible
            if (document.getElementById('debug-panel').style.display === 'block') {
                updateDebugInfo();
            }
            
            // Configurar el evento de filtrado
            document.getElementById('municipio-filter').addEventListener('change', filterData);
        }
        
        // Filtrar datos por municipio
        function filterData() {
            const municipioField = document.getElementById('municipio-select').value;
            const selectedOptions = Array.from(document.getElementById('municipio-filter').selectedOptions);
            const selectedValues = selectedOptions.map(option => option.value);
            
            dataLayer.clearLayers();
            
            let bounds = [];
            let visibleCount = 0;
            
            allData.forEach((item, index) => {
                let lat = item[document.getElementById('lat-select').value];
                let lng = item[document.getElementById('lng-select').value];
                const municipio = item[municipioField];
                
                // Verificar y limpiar coordenadas
                if (typeof lat === 'string') lat = lat.replace(',', '.').trim();
                if (typeof lng === 'string') lng = lng.replace(',', '.').trim();
                
                lat = parseFloat(lat);
                lng = parseFloat(lng);
                
                if (isNaN(lat) || isNaN(lng) || !municipio) {
                    return;
                }
                
                // Verificar si el municipio está seleccionado o si se seleccionó "todos"
                if (selectedValues.includes('all') || selectedValues.includes(municipio)) {
                    const color = municipioColors[municipio] || '#3388ff';
                    
                    const marker = L.circleMarker([lat, lng], {
                        radius: 8,
                        fillColor: color,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    let popupContent = `<div class="popup-content"><h4>${municipio}</h4>`;
                    
                    Object.entries(item).forEach(([key, value]) => {
                        if (value !== null && value !== undefined && value !== '') {
                            popupContent += `<p><strong>${key}:</strong> ${value}</p>`;
                        }
                    });
                    
                    popupContent += '</div>';
                    
                    marker.bindPopup(popupContent, { maxWidth: 300 });
                    marker.addTo(dataLayer);
                    
                    bounds.push([lat, lng]);
                    visibleCount++;
                }
            });
            
            // Ajustar el zoom para mostrar los puntos visibles
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            document.getElementById('shown-records').textContent = visibleCount;
            updateMapInfo(`Mostrando ${visibleCount} de ${allData.length} puntos`);
        }
        
        // Inicializar el mapa cuando se carga la página
        window.onload = initMap;
    </script>
</body>
</html>
