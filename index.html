<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIG Ambiental Profesional</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* Estilos mejorados y responsivos */
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f0f4f8;
        }

        #map {
            flex-grow: 1;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin: 1rem 0;
            background: white;
        }

        .control-panel {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .attribute-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            width: 90%;
            max-width: 400px;
        }

        .form-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        .gps-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #e8f4fc;
            border-radius: 8px;
            color: #2c3e50;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            background: #2ecc71;
            color: white;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .control-panel {
                padding: 0.75rem;
                gap: 0.5rem;
            }
            
            button {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-panel">
            <button class="secondary" onclick="toggleDrawing('polygon')">Polígono</button>
            <button class="secondary" onclick="toggleDrawing('polyline')">Línea</button>
            <button class="secondary" onclick="toggleDrawing('marker')">Punto</button>
            <button id="gpsToggle" onclick="toggleGPS()">GPS</button>
            <button class="outline" onclick="exportData()">Exportar</button>
            <button class="outline" onclick="document.getElementById('importFile').click()">Importar</button>
            <div class="gps-status" id="gpsStatus" style="display: none;">
                <span>Precisión: <span id="gpsAccuracy">-</span>m</span>
            </div>
        </div>

        <div id="map"></div>

        <dialog id="attributeDialog">
            <article>
                <header>
                    <h3>Registro Ambiental</h3>
                </header>
                <form id="attributeForm" class="form-grid">
                    <label>
                        Proyecto*
                        <input type="text" id="proyecto" required>
                    </label>
                    
                    <div class="grid">
                        <label>
                            Productor
                            <input type="text" id="productor">
                        </label>
                        <label>
                            Año*
                            <input type="number" id="anio" min="2000" max="2024" required>
                        </label>
                    </div>

                    <div class="grid">
                        <label>
                            Vereda
                            <input type="text" id="vereda">
                        </label>
                        <label>
                            Municipio
                            <input type="text" id="municipio">
                        </label>
                    </div>

                    <label>
                        Ecosistema
                        <select id="ecosistema">
                            <option value="">Seleccionar...</option>
                            <option value="Bosque">Bosque</option>
                            <option value="Páramo">Páramo</option>
                            <option value="Humedal">Humedal</option>
                        </select>
                    </label>

                    <label>
                        Observaciones
                        <textarea id="observaciones" rows="3"></textarea>
                    </label>

                    <footer>
                        <button type="button" onclick="closeDialog()">Cancelar</button>
                        <button type="submit" class="primary">Guardar</button>
                    </footer>
                </form>
            </article>
        </dialog>

        <div class="notification" id="notification"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-googlemutant/0.15.3/Leaflet.GoogleMutant.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Configuración inicial
        const CONFIG = {
            MAX_STORAGE: 5 * 1024 * 1024, // 5MB
            VALID_ECOSYSTEMS: ['Bosque', 'Páramo', 'Humedal'],
            DEFAULT_CENTER: [4.7110, -74.0721],
            DEFAULT_ZOOM: 13
        };

        let map, drawnItems, currentLayer, drawControl, gpsWatchId;
        let storedData = JSON.parse(localStorage.getItem('ambientalData')) || { features: [] };

        // Inicialización del mapa
        function initMap() {
            map = L.map('map', {
                center: CONFIG.DEFAULT_CENTER,
                zoom: CONFIG.DEFAULT_ZOOM,
                preferCanvas: true
            });

            // Capas base
            const baseLayers = {
                'Google Satélite': L.gridLayer.googleMutant({ type: 'hybrid' }),
                'ESRI Imagery': L.tileLayer(
                    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                )
            };

            baseLayers['Google Satélite'].addTo(map);
            L.control.layers(baseLayers).addTo(map);

            // Configuración de dibujo
            setupDrawingTools();
            loadStoredData();
            setupEventListeners();
        }

        function setupDrawingTools() {
            drawnItems = new L.FeatureGroup().addTo(map);
            
            drawControl = new L.Control.Draw({
                draw: {
                    polygon: { shapeOptions: { color: '#e74c3c' } },
                    polyline: { shapeOptions: { color: '#3498db' } },
                    marker: { 
                        icon: L.icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                            iconSize: [32, 41]
                        })
                    },
                    circle: false,
                    rectangle: false
                },
                edit: { featureGroup: drawnItems }
            }).addTo(map);
        }

        function setupEventListeners() {
            map.on(L.Draw.Event.CREATED, handleDrawCreate);
            map.on(L.Draw.Event.EDITED, updateFeature);
            map.on(L.Draw.Event.DELETED, deleteFeature);
            
            document.getElementById('attributeForm').addEventListener('submit', saveFeature);
            document.getElementById('importFile').addEventListener('change', importData);
        }

        // Manejo de características dibujadas
        function handleDrawCreate(e) {
            currentLayer = e.layer;
            showAttributeDialog();
        }

        // Diálogo de atributos
        function showAttributeDialog() {
            const dialog = document.getElementById('attributeDialog');
            dialog.showModal();
        }

        function closeDialog() {
            document.getElementById('attributeDialog').close();
            drawnItems.removeLayer(currentLayer);
        }

        // Validación de datos
        function validateForm() {
            const requiredFields = ['proyecto', 'anio'];
            return requiredFields.every(id => {
                const field = document.getElementById(id);
                if (!field.value) {
                    field.reportValidity();
                    return false;
                }
                return true;
            });
        }

        // Guardar característica
        function saveFeature(e) {
            e.preventDefault();
            if (!validateForm()) return;

            const feature = {
                type: 'Feature',
                geometry: currentLayer.toGeoJSON().geometry,
                properties: getFormData(),
                metadata: {
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                }
            };

            if (checkStorageLimit()) {
                storedData.features.push(feature);
                localStorage.setItem('ambientalData', JSON.stringify(storedData));
                showNotification('Datos guardados exitosamente');
                currentLayer.bindPopup(createPopup(feature.properties)).addTo(drawnItems);
                document.getElementById('attributeDialog').close();
            }
        }

        // Más funciones (GPS, import/export, notificaciones)...
        
        // Inicialización
        window.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
