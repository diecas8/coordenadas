<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Coordenadas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            transition: background 0.3s;
        }

        h1 {
            text-align: center;
            margin: 20px;
        }

        .container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            margin: 20px;
            gap: 20px;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 30%;
            box-sizing: border-box;
        }

        label {
            display: block;
            font-weight: bold;
            margin: 10px 0 5px;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            opacity: 0.9;
        }

        #map {
            width: 65%;
            height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Nuevos estilos */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .card, #map {
                width: 100% !important;
            }
            #map {
                height: 300px;
            }
        }

        .tema-oscuro {
            background-color: #1a1a1a;
            color: white;
        }

        .tema-oscuro .card {
            background: #2a2a2a;
        }

        .theme-btn {
            background: #444 !important;
            margin-bottom: 10px;
        }

        .search-btn {
            background: #666 !important;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>Convertidor de Coordenadas</h1>

    <div class="container">
        <div class="card">
            <h2>Introducir Coordenadas</h2>
            <button class="theme-btn" onclick="cambiarTema()">üåû/üåô</button>
            <input type="text" id="buscador" placeholder="Buscar lugar...">
            <button class="search-btn" onclick="buscarLugar()">üîç Buscar</button>

            <label for="latitude">Latitud:</label>
            <input type="text" id="latitude" placeholder="Ejemplo: 1.757537">

            <label for="longitude">Longitud:</label>
            <input type="text" id="longitude" placeholder="Ejemplo: -63.823858">

            <label for="notes">Notas/Etiquetas:</label>
            <input type="text" id="notes" placeholder="Nota opcional">

            <button onclick="convertCoordinates()">Convertir y Mostrar</button>
            <button class="gps-btn" onclick="getCurrentLocation()">Capturar Ubicaci√≥n Actual</button>

            <label for="geojson-file" class="file-input">Cargar GeoJSON:</label>
            <input type="file" id="geojson-file" accept=".geojson" onchange="handleGeoJSONUpload(event)">
        </div>

        <div id="map"></div>
    </div>

    <div class="history-container">
        <table id="historyTable">
            <thead>
                <tr>
                    <th>#</th><th>Latitud</th><th>Longitud</th><th>Lat (DMS)</th><th>Lon (DMS)</th><th>Sitio</th><th>Notas</th><th>Eliminar</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="export-btn" onclick="exportToExcel()">Exportar a Excel</button>
        <button class="clear-btn" onclick="clearHistory()">Limpiar Historial</button>
    </div>

    <div class="footer">
        <p>Elaborado por Diego Casta√±o</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let map;
        let markers = [];
        let historyCount = 0;
        const savedHistory = JSON.parse(localStorage.getItem('history')) || [];
        let marcadoresCluster;

        function initializeMap() {
            map = L.map('map').setView([0, 0], 2);
            
            // Capas base
            const capasBase = {
                "Google": L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                    attribution: '¬© Google Maps'
                }),
                "Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            };
            
            capasBase.Google.addTo(map);
            L.control.layers(capasBase).addTo(map);
            
            // Cluster de marcadores
            marcadoresCluster = L.markerClusterGroup();
            map.addLayer(marcadoresCluster);

            map.on('click', async function(e) {
                const { lat, lng } = e.latlng;
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);
                
                const siteName = await getSiteName(lat, lng);
                addMarker(lat, lng, siteName);
                addToHistory(lat, lng, decimalToDMS(lat, 'lat'), decimalToDMS(lng, 'lon'), siteName, 'Capturado en Mapa');
            });
            
            restoreHistory();
        }

        function setupValidation() {
            document.getElementById('latitude').addEventListener('input', function() {
                this.style.borderColor = (this.value > 90 || this.value < -90) ? "red" : "green";
            });
            
            document.getElementById('longitude').addEventListener('input', function() {
                this.style.borderColor = (this.value > 180 || this.value < -180) ? "red" : "green";
            });
        }

        function cambiarTema() {
            document.body.classList.toggle('tema-oscuro');
        }

        function buscarLugar() {
            alert("Funci√≥n de b√∫squeda en desarrollo üöß");
        }

        // Resto de funciones originales (getSiteName, convertCoordinates, decimalToDMS, etc.)
        async function getSiteName(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                return data.display_name || 'Sitio desconocido';
            } catch (error) {
                console.error("Error:", error);
                return 'Sitio desconocido';
            }
        }

        function convertCoordinates() {
            const latInput = parseFloat(document.getElementById('latitude').value);
            const lonInput = parseFloat(document.getElementById('longitude').value);
            const notes = document.getElementById('notes').value.trim();

            if (isNaN(latInput) || isNaN(lonInput)) {
                alert('Coordenadas inv√°lidas');
                return;
            }

            const dmsLat = decimalToDMS(latInput, 'lat');
            const dmsLon = decimalToDMS(lonInput, 'lon');

            getSiteName(latInput, lonInput).then(siteName => {
                addMarker(latInput, lonInput, siteName);
                addToHistory(latInput, lonInput, dmsLat, dmsLon, siteName, notes);
            });
        }

        // ... (Mant√©n aqu√≠ el resto de tus funciones originales sin cambios)

        window.onload = function() {
            initializeMap();
            setupValidation();
        };
    </script>
</body>
</html>
