<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cartogr√°fico Completo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f9;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
        }

        .container {
            display: flex;
            gap: 20px;
            height: 80vh;
        }

        .panel-control {
            width: 320px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #map {
            flex: 1;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .input-group {
            margin-bottom: 15px;
        }

        input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        .historial {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        #attributeForm {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Gestor Cartogr√°fico Avanzado</h1>
    
    <div class="container">
        <div class="panel-control">
            <div class="input-group">
                <input type="text" id="latitude" placeholder="Latitud">
                <input type="text" id="longitude" placeholder="Longitud">
                <button onclick="capturarCoordenadas()">‚ûï Agregar Punto</button>
                <button onclick="iniciarGPS()">üìç Usar GPS</button>
                <button onclick="iniciarRuta()">üõ£Ô∏è Iniciar Ruta</button>
            </div>
            
            <div class="herramientas">
                <button onclick="activarDibujo('polygon')">üîµ Pol√≠gono</button>
                <button onclick="activarDibujo('polyline')">üìè L√≠nea</button>
                <button onclick="activarDibujo('marker')">üìç Punto</button>
            </div>

            <div class="historial">
                <h3>Historial</h3>
                <div id="historyTable"></div>
                <button onclick="exportarGeoJSON()">üì§ GeoJSON</button>
                <button onclick="exportarExcel()">üìä Excel</button>
                <button onclick="limpiarHistorial()">üßπ Limpiar</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <div id="attributeForm">
        <h3>üìù Registro de Atributos</h3>
        <input type="text" id="nombreSitio" placeholder="Nombre del Sitio" required>
        <input type="text" id="propietario" placeholder="Propietario/Responsable">
        <textarea id="observaciones" placeholder="Observaciones"></textarea>
        <button onclick="guardarAtributos()">üíæ Guardar</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let map, drawnItems, currentLayer;
        let rutaActiva = null;
        let watchID = null;
        const historial = JSON.parse(localStorage.getItem('historial')) || [];

        // Inicializaci√≥n del Mapa
        function inicializarMapa() {
            map = L.map('map').setView([4.7110, -74.0721], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Configuraci√≥n de herramientas de dibujo
            drawnItems = new L.FeatureGroup().addTo(map);
            new L.Control.Draw({
                draw: {
                    polygon: { shapeOptions: { color: '#e74c3c' } },
                    polyline: { shapeOptions: { color: '#2ecc71' } },
                    marker: { icon: L.icon({ iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png' }) },
                    circle: false,
                    rectangle: false
                },
                edit: { featureGroup: drawnItems }
            }).addTo(map);

            // Eventos de dibujo
            map.on(L.Draw.Event.CREATED, function(e) {
                currentLayer = e.layer;
                mostrarFormularioAtributos();
                drawnItems.addLayer(currentLayer);
            });

            cargarHistorial();
        }

        // Funcionalidad GPS
        function iniciarGPS() {
            if (!navigator.geolocation) {
                alert("Tu navegador no soporta geolocalizaci√≥n");
                return;
            }

            navigator.geolocation.getCurrentPosition(posicion => {
                const lat = posicion.coords.latitude;
                const lng = posicion.coords.longitude;
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);
                map.setView([lat, lng], 16);
            }, error => {
                alert("Error obteniendo ubicaci√≥n: " + error.message);
            });
        }

        // Registro de Ruta GPS
        function iniciarRuta() {
            if (!navigator.geolocation) return;
            
            rutaActiva = L.polyline([], { color: '#3498db' }).addTo(map);
            watchID = navigator.geolocation.watchPosition(posicion => {
                const latlng = [posicion.coords.latitude, posicion.coords.longitude];
                rutaActiva.addLatLng(latlng);
                map.panTo(latlng);
            });
        }

        // Gesti√≥n de Atributos
        function mostrarFormularioAtributos() {
            document.getElementById('attributeForm').style.display = 'block';
        }

        function guardarAtributos() {
            const feature = {
                type: 'Feature',
                geometry: currentLayer.toGeoJSON().geometry,
                properties: {
                    nombre: document.getElementById('nombreSitio').value,
                    propietario: document.getElementById('propietario').value,
                    observaciones: document.getElementById('observaciones').value,
                    fecha: new Date().toISOString()
                }
            };
            
            historial.push(feature);
            localStorage.setItem('historial', JSON.stringify(historial));
            document.getElementById('attributeForm').style.display = 'none';
            actualizarHistorial();
        }

        // Exportaci√≥n de Datos
        function exportarGeoJSON() {
            const geoJSON = {
                type: 'FeatureCollection',
                features: historial
            };
            
            const blob = new Blob([JSON.stringify(geoJSON)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'mapa-datos.geojson';
            link.click();
        }

        function exportarExcel() {
            const datos = historial.map(item => ({
                Nombre: item.properties.nombre,
                Propietario: item.properties.propietario,
                Observaciones: item.properties.observaciones,
                Latitud: item.geometry.coordinates[1],
                Longitud: item.geometry.coordinates[0],
                Tipo: item.geometry.type
            }));

            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datos");
            XLSX.writeFile(wb, "datos-mapa.xlsx");
        }

        // Funciones Auxiliares
        function cargarHistorial() {
            historial.forEach(item => {
                const layer = L.geoJSON(item, {
                    pointToLayer: (feature, latlng) => L.marker(latlng),
                    style: { color: '#e74c3c' }
                }).bindPopup(`<b>${item.properties.nombre}</b><br>${item.properties.observaciones}`);
                drawnItems.addLayer(layer);
            });
        }

        function limpiarHistorial() {
            localStorage.removeItem('historial');
            location.reload();
        }

        // Inicializaci√≥n
        window.onload = inicializarMapa;
    </script>
</body>
</html>
