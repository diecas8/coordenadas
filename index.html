<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Coordenadas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            transition: background 0.3s;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 30%;
        }

        #map {
            flex-grow: 1;
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.9;
        }

        .history-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .tema-oscuro {
            background-color: #1a1a1a;
            color: white;
        }

        .tema-oscuro .card, .tema-oscuro .history-container {
            background: #2a2a2a;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .card, #map {
                width: 100% !important;
            }
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <h1>Convertidor de Coordenadas</h1>
    
    <div class="container">
        <div class="card">
            <button onclick="cambiarTema()">üåû/üåô Tema</button>
            <input type="text" id="buscador" placeholder="Buscar lugar...">
            
            <label>Latitud:</label>
            <input type="text" id="latitude" placeholder="Ej: 4.7110">
            
            <label>Longitud:</label>
            <input type="text" id="longitude" placeholder="Ej: -74.0721">
            
            <label>Notas:</label>
            <input type="text" id="notes" placeholder="Notas opcionales">
            
            <button onclick="convertCoordinates()">Convertir</button>
            <button onclick="getCurrentLocation()">üìç Ubicaci√≥n Actual</button>
            
            <input type="file" id="geojson-file" accept=".geojson" 
                   style="margin-top: 10px;" onchange="handleGeoJSONUpload(event)">
        </div>
        
        <div id="map"></div>
    </div>

    <div class="history-container">
        <table id="historyTable">
            <thead>
                <tr>
                    <th>#</th><th>Lat</th><th>Lon</th><th>Lat (DMS)</th>
                    <th>Lon (DMS)</th><th>Sitio</th><th>Notas</th><th>üóëÔ∏è</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="exportToExcel()">üì§ Exportar Excel</button>
        <button onclick="clearHistory()">üßπ Limpiar</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let map, marcadoresCluster;
        let markers = [];
        let savedHistory = JSON.parse(localStorage.getItem('history')) || [];
        
        // Inicializar mapa
        function initializeMap() {
            map = L.map('map').setView([4.7110, -74.0721], 5);
            
            // Capas base
            const capas = {
                "Google": L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    subdomains: ['mt0','mt1','mt2','mt3'],
                    attribution: '¬© Google Maps'
                }),
                "Sat√©lite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            };
            capas.Google.addTo(map);
            L.control.layers(capas).addTo(map);
            
            // Cluster de marcadores
            marcadoresCluster = L.markerClusterGroup();
            map.addLayer(marcadoresCluster);
            
            // Eventos
            map.on('click', async e => {
                document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
                convertCoordinates();
            });
            
            restoreHistory();
        }

        // Restaurar historial
        function restoreHistory() {
            savedHistory.forEach(entry => {
                addToHistory(entry.lat, entry.lon, 
                           entry.dmsLat, entry.dmsLon, 
                           entry.siteName, entry.notes, 
                           false);
            });
        }

        // Convertir coordenadas
        async function convertCoordinates() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const notes = document.getElementById('notes').value;
            
            if(isNaN(lat) return alert('Latitud inv√°lida');
            if(isNaN(lon)) return alert('Longitud inv√°lida');
            
            const siteName = await getSiteName(lat, lon);
            const dmsLat = decimalToDMS(lat, 'lat');
            const dmsLon = decimalToDMS(lon, 'lon');
            
            addMarker(lat, lon, siteName);
            addToHistory(lat, lon, dmsLat, dmsLon, siteName, notes);
        }

        // A√±adir marcador
        function addMarker(lat, lon, siteName) {
            const marker = L.marker([lat, lon]).addTo(marcadoresCluster);
            marker.bindPopup(`<b>${siteName}</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}`);
            markers.push(marker);
        }

        // A√±adir al historial
        function addToHistory(lat, lon, dmsLat, dmsLon, siteName, notes, save = true) {
            const row = `<tr>
                <td>${historyTable.rows.length}</td>
                <td>${lat.toFixed(6)}</td>
                <td>${lon.toFixed(6)}</td>
                <td>${dmsLat}</td>
                <td>${dmsLon}</td>
                <td contenteditable>${siteName}</td>
                <td contenteditable>${notes}</td>
                <td><button onclick="deleteEntry(${markers.length - 1})">üóëÔ∏è</button></td>
            </tr>`;
            
            document.querySelector('#historyTable tbody').innerHTML += row;
            
            if(save) {
                savedHistory.push({ lat, lon, dmsLat, dmsLon, siteName, notes });
                localStorage.setItem('history', JSON.stringify(savedHistory));
            }
        }

        // Funciones auxiliares
        async function getSiteName(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                return data.display_name || 'Ubicaci√≥n desconocida';
            } catch {
                return 'Ubicaci√≥n desconocida';
            }
        }

        function decimalToDMS(decimal, type) {
            const abs = Math.abs(decimal);
            const deg = Math.floor(abs);
            const min = Math.floor((abs - deg) * 60);
            const sec = ((abs - deg - min/60) * 3600).toFixed(2);
            const dir = type === 'lat' ? (decimal > 0 ? 'N' : 'S') : (decimal > 0 ? 'E' : 'W');
            return `${deg}¬∞${min}'${sec}"${dir}`;
        }

        // Funciones de UI
        function cambiarTema() {
            document.body.classList.toggle('tema-oscuro');
        }

        function deleteEntry(index) {
            if(!confirm('¬øEliminar entrada?')) return;
            markers[index].remove();
            markers.splice(index, 1);
            savedHistory.splice(index, 1);
            localStorage.setItem('history', JSON.stringify(savedHistory));
            location.reload();
        }

        function clearHistory() {
            if(!confirm('¬øBorrar todo el historial?')) return;
            localStorage.removeItem('history');
            location.reload();
        }

        function exportToExcel() {
            const wb = XLSX.utils.table_to_book(historyTable);
            XLSX.writeFile(wb, 'Historial.xlsx');
        }

        // Inicializaci√≥n
        window.onload = initializeMap;
    </script>
</body>
</html>
