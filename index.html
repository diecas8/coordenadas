<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cartográfico Profesional</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            flex-grow: 1;
            gap: 20px;
            margin-top: 20px;
        }

        .control-panel {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
        }

        #map {
            flex-grow: 1;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #attributeForm {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .footer {
            text-align: center;
            padding: 15px;
            margin-top: 20px;
            color: #666;
        }

        .tema-oscuro {
            background: #2c3e50;
            color: white;
        }

        .tema-oscuro .control-panel {
            background: #34495e;
        }
    </style>
</head>
<body>
    <h1>🗺️ Gestor Cartográfico</h1>
    
    <div class="container">
        <div class="control-panel">
            <button onclick="cambiarTema()">🌞/🌙 Tema</button>
            <button onclick="exportToExcel()" style="margin: 10px 0;">📊 Exportar Excel</button>
            <button onclick="exportToGeoJSON()">📤 Exportar GeoJSON</button>
            <input type="file" id="geojson-file" accept=".geojson" style="margin: 10px 0;" onchange="handleGeoJSONUpload(event)">
            <div style="margin: 15px 0; border-top: 1px solid #ddd; padding-top: 15px;">
                <h3>Herramientas de Dibujo</h3>
                <button onclick="activarDibujo('marker')">📍 Punto</button>
                <button onclick="activarDibujo('polyline')">📏 Línea</button>
                <button onclick="activarDibujo('polygon')">🔵 Polígono</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <div id="attributeForm">
        <h3>📝 Atributos</h3>
        <input type="text" id="sitio" placeholder="Sitio" required><br>
        <input type="text" id="propietario" placeholder="Propietario"><br>
        <textarea id="observaciones" placeholder="Observaciones"></textarea><br>
        <button onclick="guardarAtributos()">💾 Guardar</button>
    </div>

    <div class="footer">
        <p>Desarrollado por Diego Castaño | Versión 2.0</p>
    </div>

    <!-- Dependencias -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-googlemutant/0.15.3/Leaflet.GoogleMutant.min.js"></script>

    <script>
        let map, drawnItems, drawControl, currentDrawTool;
        let marcadoresCluster = L.markerClusterGroup();
        const elementos = JSON.parse(localStorage.getItem('elementos')) || [];

        function initializeMap() {
            // Configurar mapa base
            map = L.map('map').setView([4.7110, -74.0721], 6);
            
            // Capas base
            const googleLayer = L.gridLayer.googleMutant({
                type: 'roadmap',
                maxZoom: 20
            });

            const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

            // Control de capas
            L.control.layers({
                'Google Maps': googleLayer,
                'ESRI Satélite': esriSatellite
            }).addTo(map);

            googleLayer.addTo(map);

            // Configurar herramientas de dibujo
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Clusterización de marcadores
            map.addLayer(marcadoresCluster);

            // Eventos de dibujo
            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                document.getElementById('attributeForm').style.display = 'block';
                layer.on('click', function() {
                    mostrarAtributos(layer);
                });
                drawnItems.addLayer(layer);
            });

            cargarElementosGuardados();
        }

        function activarDibujo(tipo) {
            if(currentDrawTool) map.removeControl(currentDrawTool);
            
            const options = {
                polygon: tipo === 'polygon',
                polyline: tipo === 'polyline',
                marker: tipo === 'marker',
                circle: false,
                rectangle: false
            };

            currentDrawTool = new L.Control.Draw({
                draw: options,
                edit: { featureGroup: drawnItems }
            }).addTo(map);
        }

        function guardarAtributos() {
            const elemento = {
                tipo: 'Feature',
                geometry: drawnItems.getLayers()[drawnItems.getLayers().length - 1].toGeoJSON().geometry,
                propiedades: {
                    sitio: document.getElementById('sitio').value,
                    propietario: document.getElementById('propietario').value,
                    observaciones: document.getElementById('observaciones').value
                }
            };

            elementos.push(elemento);
            localStorage.setItem('elementos', JSON.stringify(elementos));
            document.getElementById('attributeForm').style.display = 'none';
        }

        function exportToGeoJSON() {
            const geoJSON = {
                type: 'FeatureCollection',
                features: elementos
            };

            const blob = new Blob([JSON.stringify(geoJSON)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'mapa-exportado.geojson';
            link.click();
        }

        function exportToExcel() {
            const datos = elementos.map(item => ({
                Sitio: item.propiedades.sitio,
                Propietario: item.propiedades.propietario,
                Observaciones: item.propiedades.observaciones,
                Tipo: item.geometry.type,
                Coordenadas: JSON.stringify(item.geometry.coordinates)
            }));

            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datos");
            XLSX.writeFile(wb, "datos-mapa.xlsx");
        }

        function handleGeoJSONUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const geoJSON = JSON.parse(e.target.result);
                L.geoJSON(geoJSON, {
                    onEachFeature: (feature, layer) => {
                        elementos.push(feature);
                        drawnItems.addLayer(layer);
                    }
                }).addTo(map);
            };
            reader.readAsText(file);
        }

        function cambiarTema() {
            document.body.classList.toggle('tema-oscuro');
            document.querySelector('.control-panel').classList.toggle('tema-oscuro');
        }

        function cargarElementosGuardados() {
            elementos.forEach(elemento => {
                const layer = L.geoJSON(elemento, {
                    pointToLayer: (feature, latlng) => L.marker(latlng),
                    style: { color: '#3388ff' }
                }).bindPopup(`<b>${elemento.propiedades.sitio}</b><br>${elemento.propiedades.observaciones}`);
                
                drawnItems.addLayer(layer);
            });
        }

        // Inicializar mapa al cargar
        window.onload = initializeMap;
    </script>
</body>
</html>
