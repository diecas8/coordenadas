<!DOCTYPE html>
<html>
<head>
    <title>Geoportal de Coordenadas (Conversión a Planas)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
    <style>
        /* CSS Integrado */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        h1, h2 {
            color: #0056b3;
            text-align: center;
        }

        #map {
            height: 500px;
            width: 80%;
            margin: 20px auto;
            border: 1px solid #ddd;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9e9e9;
            border-radius: 8px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .controls label {
            font-weight: bold;
            margin-right: 10px;
        }

        .controls input[type="text"], .controls select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 250px;
            margin-bottom: 10px;
        }

        .file-upload {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            font-size: 0.9em;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .credits {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #666;
        }
        
        .tab-container {
            width: 80%;
            margin: 0 auto;
        }
        
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: #333;
        }
        
        .tab button:hover {
            background-color: #ddd;
        }
        
        .tab button.active {
            background-color: #007bff;
            color: white;
        }
        
        .tabcontent {
            display: none;
            padding: 15px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background-color: white;
        }
        
        .coords-input {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .format-info {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .preview-container {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .config-panel {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
        
        .config-panel h4 {
            margin-top: 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <h1>Geoportal de Coordenadas (Conversión a Planas)</h1>

    <div class="tab-container">
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'MapTab')">Mapa</button>
            <button class="tablinks" onclick="openTab(event, 'UploadTab')">Cargar Coordenadas</button>
            <button class="tablinks" onclick="openTab(event, 'ConvertTab')">Convertir Coordenadas</button>
        </div>
        
        <div id="MapTab" class="tabcontent" style="display:block;">
            <div id="map"></div>

            <div class="controls">
                <label for="siteName">Nombre del Sitio:</label>
                <input type="text" id="siteName" placeholder="Ej: Mi casa, Parque principal">
                <p>Haga clic en el mapa para capturar coordenadas.</p>
                <p>Coordenadas Capturadas: <span id="capturedCoords">N/A</span></p>
            </div>
        </div>
        
        <div id="UploadTab" class="tabcontent">
            <div class="controls">
                <h3>Cargar múltiples coordenadas</h3>
                
                <div class="format-info">
                    <p><strong>Formatos aceptados:</strong></p>
                    <ul>
                        <li><strong>DMS (Grados, Minutos, Segundos):</strong> 5°85'0.4"N, 70°57'2.3"W</li>
                        <li><strong>Decimal:</strong> 4.746, -74.042</li>
                        <li><strong>Archivos con encabezados y diferentes separadores</strong></li>
                    </ul>
                </div>
                
                <div class="config-panel">
                    <h4>Configuración del archivo</h4>
                    <label>
                        <input type="checkbox" id="hasHeader" checked> El archivo tiene fila de encabezado
                    </label>
                    <br>
                    <label>Separador:
                        <select id="separator">
                            <option value=",">Coma (,)</option>
                            <option value=";">Punto y coma (;)</option>
                            <option value="tab">Tabulador</option>
                            <option value="|">Pipe (|)</option>
                            <option value="auto">Detección automática</option>
                        </select>
                    </label>
                    <br>
                    <label>Columnas (índice base 1):
                        <input type="number" id="nameCol" placeholder="Nombre" value="1" min="1" style="width: 60px;">
                        <input type="number" id="latCol" placeholder="Latitud" value="2" min="1" style="width: 60px;">
                        <input type="number" id="lngCol" placeholder="Longitud" value="3" min="1" style="width: 60px;">
                    </label>
                </div>
                
                <textarea id="batchCoords" class="coords-input" placeholder="Pegue aquí el contenido del archivo o use el botón para cargar un archivo..."></textarea>
                <button onclick="processBatchCoords()">Procesar Coordenadas</button>
                
                <div class="file-upload">
                    <p>O cargar desde un archivo:</p>
                    <input type="file" id="csvFile" accept=".csv,.txt">
                    <button onclick="processFile()">Procesar Archivo</button>
                </div>
                
                <div class="preview-container">
                    <h4>Vista previa (primeras 5 líneas):</h4>
                    <div id="filePreview"></div>
                </div>
            </div>
        </div>
        
        <div id="ConvertTab" class="tabcontent">
            <div class="controls">
                <h3>Convertir coordenadas a planas</h3>
                <label for="projectionSelect">Sistema de coordenadas:</label>
                <select id="projectionSelect">
                    <option value="EPSG:3857">Web Mercator (EPSG:3857)</option>
                    <option value="EPSG:21897">Colombia Bogotá Zone (EPSG:21897)</option>
                    <option value="EPSG:3116">Colombia MAGNA (EPSG:3116)</option>
                    <option value="EPSG:32618">WGS 84 / UTM zone 18N (EPSG:32618)</option>
                </select>
                <button onclick="convertToPlanas()">Convertir a Coordenadas Planas</button>
                <button onclick="exportToCSV()">Exportar a CSV</button>
            </div>
        </div>
    </div>

    <h2>Sitios Registrados</h2>
    <table id="locationsTable">
        <thead>
            <tr>
                <th>Nombre del Sitio</th>
                <th>Latitud</th>
                <th>Longitud</th>
                <th>Coordenada X (Plana)</th>
                <th>Coordenada Y (Plana)</th>
                <th>Sistema</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div class="credits">
        Elaborado por Diego Castaño, Esp SIG, 2025.
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // Definir sistemas de coordenadas para proj4
        proj4.defs("EPSG:21897", "+proj=tmerc +lat_0=4.596200416666666 +lon_0=-74.07750791666666 +k=1 +x_0=1000000 +y_0=1000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
        proj4.defs("EPSG:3116", "+proj=tmerc +lat_0=4.596200416666666 +lon_0=-74.07750791666666 +k=1 +x_0=1000000 +y_0=1000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
        proj4.defs("EPSG:32618", "+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs");
        proj4.defs("EPSG:3857", "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs");

        let map;
        let temporaryMarker;
        let permanentMarkers = L.layerGroup();
        let locations = [];
        let fileContent = "";

        // Coordenadas iniciales (Cartago, Colombia)
        const initialLat = 4.020786;
        const initialLng = -76.155490;
        const initialZoom = 15;

        // Inicializar el mapa de Leaflet
        map = L.map('map').setView([initialLat, initialLng], initialZoom);

        // Definir las capas base
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        const esriSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Añadir la capa OpenStreetMap por defecto
        osmLayer.addTo(map);

        // Definir las capas base para el control de capas
        const baseMaps = {
            "OpenStreetMap": osmLayer,
            "Esri Satélite": esriSatelliteLayer
        };

        // Añadir los marcadores permanentes al mapa como una capa de grupo
        permanentMarkers.addTo(map);

        // Añadir el control de capas al mapa
        L.control.layers(baseMaps).addTo(map);

        // Función para convertir coordenadas DMS a decimal
        function parseDMSString(dmsString) {
            if (typeof dmsString !== 'string') {
                return parseFloat(dmsString);
            }
            
            // Verificar si ya es un número decimal
            if (!isNaN(dmsString) && dmsString !== '') {
                return parseFloat(dmsString);
            }
            
            // Expresión regular para analizar formato DMS (ej: 5°85'0.4"N)
            const regex = /([0-9]{1,3})[°\s]+\s*([0-9]{1,2})['\s]+\s*([0-9]{1,2}(?:\.[0-9]+)?)[\"\s]+\s*([NSEWO])?/i;
            const match = dmsString.trim().match(regex);
            
            if (!match) {
                // Intentar con formato más simple (ej: 5°85'0.4)
                const simpleRegex = /([0-9]{1,3})[°\s]+\s*([0-9]{1,2})['\s]+\s*([0-9]{1,2}(?:\.[0-9]+)?)/i;
                const simpleMatch = dmsString.trim().match(simpleRegex);
                
                if (!simpleMatch) {
                    throw new Error(`Formato DMS no reconocido: ${dmsString}`);
                }
                
                const degrees = parseFloat(simpleMatch[1]);
                const minutes = parseFloat(simpleMatch[2]);
                const seconds = parseFloat(simpleMatch[3]);
                
                return degrees + (minutes / 60) + (seconds / 3600);
            }
            
            const degrees = parseFloat(match[1]);
            const minutes = parseFloat(match[2]);
            const seconds = parseFloat(match[3]);
            const direction = match[4] ? match[4].toUpperCase() : '';
            
            let decimal = degrees + (minutes / 60) + (seconds / 3600);
            
            // Ajustar según la dirección (N/S/E/O)
            if (direction === 'S' || direction === 'W' || direction === 'O') {
                decimal = -decimal;
            }
            
            return decimal;
        }

        // Función para detectar el separador automáticamente
        function detectSeparator(text) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            if (lines.length < 2) return ",";
            
            // Probar con las primeras 5 líneas
            const sampleLines = lines.slice(0, Math.min(5, lines.length));
            
            const commaCounts = sampleLines.map(line => (line.match(/,/g) || []).length);
            const semicolonCounts = sampleLines.map(line => (line.match(/;/g) || []).length);
            const tabCounts = sampleLines.map(line => (line.match(/\t/g) || []).length);
            const pipeCounts = sampleLines.map(line => (line.match(/\|/g) || []).length);
            
            const avgCommas = commaCounts.reduce((a, b) => a + b, 0) / commaCounts.length;
            const avgSemicolons = semicolonCounts.reduce((a, b) => a + b, 0) / semicolonCounts.length;
            const avgTabs = tabCounts.reduce((a, b) => a + b, 0) / tabCounts.length;
            const avgPipes = pipeCounts.reduce((a, b) => a + b, 0) / pipeCounts.length;
            
            if (avgTabs > avgCommas && avgTabs > avgSemicolons && avgTabs > avgPipes) return "tab";
            if (avgSemicolons > avgCommas && avgSemicolons > avgPipes) return ";";
            if (avgPipes > avgCommas) return "|";
            return ",";
        }

        // Función para procesar el contenido del archivo
        function processFileContent(content) {
            const hasHeader = document.getElementById('hasHeader').checked;
            let separator = document.getElementById('separator').value;
            const nameCol = parseInt(document.getElementById('nameCol').value) - 1;
            const latCol = parseInt(document.getElementById('latCol').value) - 1;
            const lngCol = parseInt(document.getElementById('lngCol').value) - 1;
            
            if (separator === 'auto') {
                separator = detectSeparator(content);
            }
            
            const actualSeparator = separator === 'tab' ? '\t' : separator;
            const lines = content.split('\n').filter(line => line.trim().length > 0);
            
            let startLine = hasHeader ? 1 : 0;
            let processed = 0;
            let errors = 0;
            let errorMessages = [];
            
            for (let i = startLine; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                let parts;
                if (actualSeparator === ',') {
                    // Manejar CSV con comas dentro de comillas
                    parts = line.split(',').map(part => part.replace(/^"|"$/g, '').trim());
                } else {
                    parts = line.split(actualSeparator).map(part => part.trim());
                }
                
                if (Math.max(nameCol, latCol, lngCol) >= parts.length) {
                    errors++;
                    errorMessages.push(`Línea ${i + 1}: No hay suficientes columnas`);
                    continue;
                }
                
                const name = parts[nameCol] || `Punto ${i + 1}`;
                const latStr = parts[latCol];
                const lngStr = parts[lngCol];
                
                try {
                    let lat, lng;
                    
                    try {
                        lat = parseDMSString(latStr);
                    } catch (e) {
                        lat = parseFloat(latStr);
                        if (isNaN(lat)) {
                            throw new Error(`Latitud no válida: ${latStr}`);
                        }
                    }
                    
                    try {
                        lng = parseDMSString(lngStr);
                    } catch (e) {
                        lng = parseFloat(lngStr);
                        if (isNaN(lng)) {
                            throw new Error(`Longitud no válida: ${lngStr}`);
                        }
                    }
                    
                    if (isNaN(lat) || isNaN(lng)) {
                        throw new Error(`Coordenadas no válidas: ${latStr}, ${lngStr}`);
                    }
                    
                    addLocation(lat, lng, name);
                    processed++;
                } catch (error) {
                    errors++;
                    errorMessages.push(`Línea ${i + 1}: ${error.message}`);
                }
            }
            
            return { processed, errors, errorMessages };
        }

        // Función para mostrar vista previa del archivo
        function updateFilePreview(content) {
            const preview = document.getElementById('filePreview');
            const lines = content.split('\n').filter(line => line.trim().length > 0);
            const previewLines = lines.slice(0, 5);
            
            preview.innerHTML = previewLines.map((line, index) => 
                `<div>${index + 1}: ${line}</div>`
            ).join('');
            
            if (lines.length > 5) {
                preview.innerHTML += `<div>... (${lines.length - 5} líneas más)</div>`;
            }
        }

        // Evento para capturar coordenadas al hacer clic en el mapa
        map.on('click', (e) => {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            document.getElementById('capturedCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            if (temporaryMarker) {
                map.removeLayer(temporaryMarker);
            }

            temporaryMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup(`
                    <div>
                        <h3>Asignar Nombre al Sitio</h3>
                        <p>Lat: ${lat.toFixed(6)}</p>
                        <p>Lng: ${lng.toFixed(6)}</p>
                        <label for="infoWindowSiteName">Nombre:</label>
                        <input type="text" id="infoWindowSiteName" placeholder="Nombre del sitio">
                        <button onclick="addLocation('${lat}', '${lng}')">Agregar Sitio</button>
                    </div>
                `, { autoPan: false }).openPopup();
        });

        function addLocation(lat, lng, name = null) {
            const siteName = name || (document.getElementById('infoWindowSiteName') ? 
                                    document.getElementById('infoWindowSiteName').value.trim() : 
                                    document.getElementById('siteName').value.trim());
            
            if (!siteName) {
                alert('Por favor, ingrese un nombre para el sitio.');
                return;
            }

            const location = {
                name: siteName,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                x: null,
                y: null,
                projection: null
            };
            
            locations.push(location);
            updateTable();
            
            const newPermanentMarker = L.marker([parseFloat(lat), parseFloat(lng)])
                .bindPopup(`<b>${siteName}</b><br>Lat: ${parseFloat(lat).toFixed(6)}<br>Lng: ${parseFloat(lng).toFixed(6)}`);
            permanentMarkers.addLayer(newPermanentMarker);

            document.getElementById('siteName').value = '';
            document.getElementById('capturedCoords').textContent = 'N/A';

            if (temporaryMarker) {
                map.removeLayer(temporaryMarker);
                temporaryMarker = null;
            }

            map.closePopup();
            
            return location;
        }

        function updateTable() {
            const tableBody = document.getElementById('locationsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            locations.forEach(location => {
                const newRow = tableBody.insertRow();
                
                const nameCell = newRow.insertCell(0);
                const latCell = newRow.insertCell(1);
                const lngCell = newRow.insertCell(2);
                const xCell = newRow.insertCell(3);
                const yCell = newRow.insertCell(4);
                const projCell = newRow.insertCell(5);
                
                nameCell.textContent = location.name;
                latCell.textContent = location.lat.toFixed(6);
                lngCell.textContent = location.lng.toFixed(6);
                xCell.textContent = location.x ? location.x.toFixed(2) : 'No convertido';
                yCell.textContent = location.y ? location.y.toFixed(2) : 'No convertido';
                projCell.textContent = location.projection || 'N/A';
            });
        }

        function processBatchCoords() {
            const coordsText = document.getElementById('batchCoords').value;
            if (!coordsText.trim()) {
                alert('Por favor, ingrese coordenadas en el formato especificado.');
                return;
            }
            
            const result = processFileContent(coordsText);
            
            let message = `Procesamiento completado: ${result.processed} coordenadas añadidas, ${result.errors} errores.`;
            if (result.errorMessages.length > 0) {
                message += "\n\nErrores:\n" + result.errorMessages.slice(0, 10).join("\n");
                if (result.errorMessages.length > 10) {
                    message += `\n... (${result.errorMessages.length - 10} errores más)`;
                }
            }
            
            alert(message);
        }

        function processFile() {
            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files.length) {
                alert('Por favor, seleccione un archivo.');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                fileContent = e.target.result;
                document.getElementById('batchCoords').value = fileContent;
                updateFilePreview(fileContent);
                processBatchCoords();
            };
            
            reader.readAsText(file);
        }

        function convertToPlanas() {
            if (locations.length === 0) {
                alert('No hay coordenadas para convertir. Por favor, cargue algunas coordenadas primero.');
                return;
            }
            
            const projectionCode = document.getElementById('projectionSelect').value;
            
            locations.forEach(location => {
                try {
                    const result = proj4('EPSG:4326', projectionCode, [location.lng, location.lat]);
                    location.x = result[0];
                    location.y = result[1];
                    location.projection = projectionCode;
                } catch (error) {
                    console.error('Error en conversión:', error);
                }
            });
            
            updateTable();
            alert('Conversión completada.');
        }

        function exportToCSV() {
            const hasConverted = locations.some(loc => loc.x !== null && loc.y !== null);
            if (!hasConverted) {
                alert('Primero debe convertir las coordenadas a planas antes de exportar.');
                return;
            }
            
            let csvContent = "Nombre,Latitud,Longitud,X,Y,Sistema\n";
            
            locations.forEach(location => {
                csvContent += `"${location.name}",${location.lat},${location.lng},${location.x},${location.y},${location.projection}\n`;
            });
            
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "coordenadas_convertidas.csv");
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName('tabcontent');
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName('tablinks');
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // Inicializar con un ejemplo
        document.getElementById('batchCoords').value = `Punto 1,5°85'0.4"N,70°57'2.3"W
Punto 2,4.735,-74.042
Punto 3,6°15'30.8"N,75°35'15.3"W`;
        updateFilePreview(document.getElementById('batchCoords').value);
    </script>
</body>
</html>
