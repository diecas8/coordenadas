<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Cartogr√°fico Profesional</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: #f0f0f5;
            transition: background 0.3s;
        }

        .container {
            display: flex;
            flex-grow: 1;
            gap: 20px;
            margin-top: 20px;
        }

        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
            transition: background 0.3s;
        }

        #map {
            flex-grow: 1;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .boton {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .boton:hover {
            background: #2980b9;
        }

        #attributeForm {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .tema-oscuro {
            background: #2c3e50;
            color: white;
        }

        .tema-oscuro .control-panel {
            background: #34495e;
        }

        .footer {
            text-align: center;
            padding: 15px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Gestor Cartogr√°fico</h1>
    
    <div class="container">
        <div class="control-panel">
            <button class="boton" onclick="cambiarTema()">üåû/üåô Tema</button>
            <button class="boton" onclick="exportToExcel()">üìä Exportar Excel</button>
            <button class="boton" onclick="exportToGeoJSON()">üì§ Exportar GeoJSON</button>
            <input type="file" class="boton" id="geojson-file" accept=".geojson" onchange="handleGeoJSONUpload(event)">
            
            <h3 style="margin: 15px 0 10px;">Herramientas</h3>
            <button class="boton" onclick="activarDibujo('polygon')">üîµ Pol√≠gono</button>
            <button class="boton" onclick="activarDibujo('polyline')">üìè L√≠nea</button>
            <button class="boton" onclick="activarDibujo('marker')">üìç Punto</button>
            
            <h3 style="margin: 15px 0 10px;">Coordenadas</h3>
            <input type="text" id="latitude" placeholder="Latitud" class="boton">
            <input type="text" id="longitude" placeholder="Longitud" class="boton">
            <button class="boton" onclick="agregarMarcadorManual()">‚ûï Agregar</button>
        </div>
        <div id="map"></div>
    </div>

    <div id="attributeForm">
        <h3>üìù Atributos</h3>
        <input type="text" id="sitio" placeholder="Sitio" required><br>
        <input type="text" id="propietario" placeholder="Propietario"><br>
        <textarea id="observaciones" placeholder="Observaciones"></textarea><br>
        <button class="boton" onclick="guardarAtributos()">üíæ Guardar</button>
    </div>

    <div class="footer">
        <p>Desarrollado por Diego Casta√±o | Versi√≥n 3.0</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-googlemutant/0.15.3/Leaflet.GoogleMutant.min.js"></script>

    <script>
        let map, drawnItems, currentDrawTool;
        let marcadoresCluster = L.markerClusterGroup();
        const elementos = JSON.parse(localStorage.getItem('elementos')) || [];

        // 1. Inicializaci√≥n del mapa
        function initializeMap() {
            map = L.map('map').setView([4.7110, -74.0721], 6);
            
            // Capas base
            const googleLayer = L.gridLayer.googleMutant({
                type: 'roadmap',
                maxZoom: 20
            });
            
            const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
            
            L.control.layers({
                'Google Maps': googleLayer,
                'ESRI Sat√©lite': esriSatellite
            }).addTo(map);
            
            googleLayer.addTo(map);

            // Configuraci√≥n de dibujo
            drawnItems = new L.FeatureGroup().addTo(map);
            map.addLayer(marcadoresCluster);
            cargarElementosGuardados();

            // Eventos del mapa
            map.on('click', function(e) {
                document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
            });
        }

        // 2. Funciones de dibujo
        function activarDibujo(tipo) {
            if (currentDrawTool) map.removeControl(currentDrawTool);
            
            currentDrawTool = new L.Control.Draw({
                draw: {
                    [tipo]: { shapeOptions: { color: '#e74c3c' } },
                    circle: false,
                    marker: false,
                    rectangle: false
                },
                edit: { featureGroup: drawnItems }
            }).addTo(map);

            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                document.getElementById('attributeForm').style.display = 'block';
                layer.on('click', function() {
                    mostrarAtributos(layer);
                });
                drawnItems.addLayer(layer);
            });
        }

        // 3. Gesti√≥n de atributos
        function guardarAtributos() {
            const elemento = {
                type: 'Feature',
                geometry: drawnItems.getLayers().pop().toGeoJSON().geometry,
                properties: {
                    sitio: document.getElementById('sitio').value,
                    propietario: document.getElementById('propietario').value,
                    observaciones: document.getElementById('observaciones').value
                }
            };
            
            elementos.push(elemento);
            localStorage.setItem('elementos', JSON.stringify(elementos));
            document.getElementById('attributeForm').style.display = 'none';
        }

        // 4. Funciones de importaci√≥n/exportaci√≥n
        function exportToGeoJSON() {
            const geoJSON = {
                type: 'FeatureCollection',
                features: elementos
            };
            
            const blob = new Blob([JSON.stringify(geoJSON)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'mapa-exportado.geojson';
            link.click();
        }

        function exportToExcel() {
            const datos = elementos.map(item => ({
                Sitio: item.properties.sitio,
                Propietario: item.properties.propietario,
                Observaciones: item.properties.observaciones,
                Tipo: item.geometry.type,
                Coordenadas: JSON.stringify(item.geometry.coordinates)
            }));
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Datos");
            XLSX.writeFile(wb, "datos-mapa.xlsx");
        }

        function handleGeoJSONUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const geoJSON = JSON.parse(e.target.result);
                L.geoJSON(geoJSON, {
                    onEachFeature: (feature, layer) => {
                        elementos.push(feature);
                        drawnItems.addLayer(layer);
                    }
                }).addTo(map);
            };
            reader.readAsText(file);
        }

        // 5. Funciones adicionales
        function cambiarTema() {
            document.body.classList.toggle('tema-oscuro');
            document.querySelector('.control-panel').classList.toggle('tema-oscuro');
        }

        function cargarElementosGuardados() {
            elementos.forEach(elemento => {
                const layer = L.geoJSON(elemento, {
                    pointToLayer: (feature, latlng) => L.marker(latlng),
                    style: { color: '#e74c3c' }
                }).bindPopup(`<b>${elemento.properties.sitio}</b><br>${elemento.properties.observaciones}`);
                
                drawnItems.addLayer(layer);
            });
        }

        function agregarMarcadorManual() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            
            if(lat && lon) {
                const marker = L.marker([lat, lon]).addTo(marcadoresCluster);
                elementos.push({
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: [lon, lat] },
                    properties: { sitio: 'Marcador manual', observaciones: 'Agregado manualmente' }
                });
            }
        }

        // Inicializaci√≥n final
        window.onload = initializeMap;
    </script>
</body>
</html>
