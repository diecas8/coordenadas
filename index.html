<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIG Profesional - Gestión Ambiental</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex-grow: 1;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        .attribute-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <button onclick="toggleGPS()">📍 Seguimiento GPS</button>
        <button onclick="exportSelected()">📤 Exportar Selección</button>
        <button onclick="document.getElementById('geojsonInput').click()">📥 Importar GeoJSON</button>
        <input type="file" id="geojsonInput" hidden accept=".geojson">
    </div>
    <div id="map"></div>
    
    <div class="attribute-form">
        <h3>Atributos del Elemento</h3>
        <input type="text" id="proyecto" placeholder="Proyecto" required>
        <input type="text" id="productor" placeholder="Productor">
        <input type="text" id="vereda" placeholder="Vereda">
        <input type="text" id="municipio" placeholder="Municipio">
        <input type="number" id="anio" placeholder="Año" min="2000" max="2100">
        <select id="ecosistema">
            <option value="">Seleccione ecosistema</option>
            <option value="Bosque">Bosque</option>
            <option value="Páramo">Páramo</option>
            <option value="Humedal">Humedal</option>
        </select>
        <textarea id="observaciones" placeholder="Observaciones"></textarea>
        <button onclick="saveAttributes()">💾 Guardar</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-googlemutant/0.15.3/Leaflet.GoogleMutant.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let map, drawnItems, currentLayer, gpsTracker;
        const capas = new L.FeatureGroup();
        const storedData = JSON.parse(localStorage.getItem('sigData')) || { features: [] };

        // Inicialización del Mapa
        function initMap() {
            map = L.map('map').setView([4.7110, -74.0721], 13);

            // Capas base
            const baseLayers = {
                "Google Satélite": L.gridLayer.googleMutant({ type: 'hybrid' }),
                "ESRI Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            };

            baseLayers["Google Satélite"].addTo(map);
            L.control.layers(baseLayers).addTo(map);

            // Configuración de dibujo y edición
            drawnItems = new L.FeatureGroup().addTo(map);
            const drawControl = new L.Control.Draw({
                draw: { polygon: true, polyline: true, marker: true },
                edit: { featureGroup: drawnItems }
            }).addTo(map);

            map.on(L.Draw.Event.CREATED, handleDraw);
            map.on(L.Draw.Event.EDITED, saveAllData);
            
            loadStoredData();
        }

        // Manejo de dibujos
        function handleDraw(e) {
            currentLayer = e.layer;
            document.querySelector('.attribute-form').style.display = 'block';
            currentLayer.addTo(drawnItems);
        }

        // Guardar atributos
        function saveAttributes() {
            const feature = {
                type: 'Feature',
                geometry: currentLayer.toGeoJSON().geometry,
                properties: {
                    proyecto: document.getElementById('proyecto').value,
                    productor: document.getElementById('productor').value,
                    vereda: document.getElementById('vereda').value,
                    municipio: document.getElementById('municipio').value,
                    año: document.getElementById('anio').value,
                    ecosistema: document.getElementById('ecosistema').value,
                    observaciones: document.getElementById('observaciones').value,
                    fecha: new Date().toISOString()
                }
            };
            
            storedData.features.push(feature);
            localStorage.setItem('sigData', JSON.stringify(storedData));
            document.querySelector('.attribute-form').style.display = 'none';
        }

        // Seguimiento GPS
        function toggleGPS() {
            if (!gpsTracker) {
                gpsTracker = L.marker([0,0], { icon: L.divIcon({ className: 'gps-marker' }) }).addTo(map);
                navigator.geolocation.watchPosition(pos => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    gpsTracker.setLatLng(latlng);
                    map.panTo(latlng);
                });
            } else {
                map.removeLayer(gpsTracker);
                gpsTracker = null;
            }
        }

        // Exportación de datos
        function exportSelected() {
            const selectedData = {
                type: 'FeatureCollection',
                features: drawnItems.getLayers().map(layer => layer.toGeoJSON())
            };

            const blob = new Blob([JSON.stringify(selectedData)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'seleccion.geojson';
            link.click();
        }

        // Importación de GeoJSON
        document.getElementById('geojsonInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const geoJSON = JSON.parse(e.target.result);
                L.geoJSON(geoJSON, {
                    onEachFeature: (feature, layer) => {
                        storedData.features.push(feature);
                        layer.addTo(drawnItems);
                    }
                });
                localStorage.setItem('sigData', JSON.stringify(storedData));
            };
            reader.readAsText(file);
        });

        // Exportar a Excel
        function exportToExcel() {
            const worksheet = XLSX.utils.json_to_sheet(storedData.features.map(f => ({
                Proyecto: f.properties.proyecto,
                Productor: f.properties.productor,
                Vereda: f.properties.vereda,
                Municipio: f.properties.municipio,
                Año: f.properties.año,
                Ecosistema: f.properties.ecosistema,
                Observaciones: f.properties.observaciones,
                Coordenadas: JSON.stringify(f.geometry.coordinates)
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Datos");
            XLSX.writeFile(workbook, "datos_ambientales.xlsx");
        }

        // Cargar datos almacenados
        function loadStoredData() {
            storedData.features.forEach(feature => {
                L.geoJSON(feature, {
                    pointToLayer: (geoJsonPoint, latlng) => L.marker(latlng),
                    style: { color: '#3388ff' }
                }).bindPopup(createPopupContent(feature.properties)).addTo(drawnItems);
            });
        }

        function createPopupContent(properties) {
            return `<b>${properties.proyecto}</b><hr>
                    <div>Productor: ${properties.productor}</div>
                    <div>Ecosistema: ${properties.ecosistema}</div>
                    <div>Observaciones: ${properties.observaciones}</div>`;
        }

        // Inicialización
        window.onload = initMap;
    </script>
</body>
</html>
