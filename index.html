<!DOCTYPE html>
<html>
<head>
    <title>Geoportal de Coordenadas (OpenStreetMap & Esri Satélite)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        /* CSS Integrado */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        h1, h2 {
            color: #0056b3;
            text-align: center;
        }

        #map {
            height: 500px;
            width: 80%;
            margin: 20px auto;
            border: 1px solid #ddd;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9e9e9;
            border-radius: 8px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .controls label {
            font-weight: bold;
            margin-right: 10px;
        }

        .controls input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 250px;
            margin-bottom: 10px;
        }

        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .credits {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>Geoportal de Coordenadas (OpenStreetMap & Esri Satélite)</h1>

    <div id="map"></div>

    <div class="controls">
        <label for="siteName">Nombre del Sitio:</label>
        <input type="text" id="siteName" placeholder="Ej: Mi casa, Parque principal">
        <p>Haga clic en el mapa para capturar coordenadas.</p>
        <p>Coordenadas Capturadas: <span id="capturedCoords">N/A</span></p>
    </div>

    <h2>Sitios Registrados</h2>
    <table id="locationsTable">
        <thead>
            <tr>
                <th>Nombre del Sitio</th>
                <th>Latitud</th>
                <th>Longitud</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <div class="credits">
        Elaborado por Diego Castaño, Esp SIG, 2025.
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        let map;
        let temporaryMarker; // Para el marcador temporal de la ubicación seleccionada
        let permanentMarkers = L.layerGroup(); // Para almacenar los marcadores permanentes

        // Coordenadas iniciales (Cartago, Colombia)
        const initialLat = 4.020786;
        const initialLng = -76.155490;
        const initialZoom = 15;

        // Inicializar el mapa de Leaflet
        map = L.map('map').setView([initialLat, initialLng], initialZoom);

        // Definir las capas base
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        const esriSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // Añadir la capa OpenStreetMap por defecto
        osmLayer.addTo(map);

        // Definir las capas base para el control de capas
        const baseMaps = {
            "OpenStreetMap": osmLayer,
            "Esri Satélite": esriSatelliteLayer
        };

        // Añadir los marcadores permanentes al mapa como una capa de grupo
        permanentMarkers.addTo(map);

        // Añadir el control de capas al mapa
        L.control.layers(baseMaps).addTo(map);

        // Evento para capturar coordenadas al hacer clic en el mapa
        map.on('click', (e) => {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            document.getElementById('capturedCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            // Eliminar el marcador temporal anterior si existe
            if (temporaryMarker) {
                map.removeLayer(temporaryMarker);
            }

            // Crear y añadir un nuevo marcador temporal
            temporaryMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup(`
                    <div>
                        <h3>Asignar Nombre al Sitio</h3>
                        <p>Lat: ${lat.toFixed(6)}</p>
                        <p>Lng: ${lng.toFixed(6)}</p>
                        <label for="infoWindowSiteName">Nombre:</label>
                        <input type="text" id="infoWindowSiteName" placeholder="Nombre del sitio">
                        <button onclick="addLocation('${lat}', '${lng}')">Agregar Sitio</button>
                    </div>
                `, { autoPan: false }).openPopup(); // autoPan: false para que el popup no mueva el mapa al abrirse
        });

        function addLocation(lat, lng) {
            const siteNameInput = document.getElementById('infoWindowSiteName');
            const siteName = siteNameInput ? siteNameInput.value.trim() : '';

            if (!siteName) {
                alert('Por favor, ingrese un nombre para el sitio.');
                return;
            }

            const tableBody = document.getElementById('locationsTable').getElementsByTagName('tbody')[0];
            const newRow = tableBody.insertRow();

            const nameCell = newRow.insertCell(0);
            const latCell = newRow.insertCell(1);
            const lngCell = newRow.insertCell(2);

            nameCell.textContent = siteName;
            latCell.textContent = parseFloat(lat).toFixed(6);
            lngCell.textContent = parseFloat(lng).toFixed(6);

            // Añadir un marcador permanente en el mapa para el sitio registrado
            const newPermanentMarker = L.marker([parseFloat(lat), parseFloat(lng)])
                .bindPopup(`<b>${siteName}</b><br>Lat: ${parseFloat(lat).toFixed(6)}<br>Lng: ${parseFloat(lng).toFixed(6)}`);
            permanentMarkers.addLayer(newPermanentMarker); // Añadir al grupo de marcadores permanentes

            // Limpiar el campo de nombre después de agregar
            document.getElementById('siteName').value = '';
            document.getElementById('capturedCoords').textContent = 'N/A';

            // Quitar el marcador temporal después de añadir el sitio
            if (temporaryMarker) {
                map.removeLayer(temporaryMarker);
                temporaryMarker = null; // Reiniciar el marcador temporal
            }

            // Cierra el popup si está abierto después de agregar el sitio
            map.closePopup();
        }
    </script>
</body>
</html>
